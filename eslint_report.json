[{"filePath":"Z:\\Programming\\BOMIX\\electron.vite.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\database\\connection.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\database\\repositories\\bom-revision.repo.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\database\\repositories\\matrix-model.repo.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\database\\repositories\\matrix-selection.repo.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\database\\repositories\\parts.repo.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\database\\repositories\\project.repo.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\database\\repositories\\second-source.repo.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\database\\repositories\\series.repo.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\database\\schema.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\ipc\\app.ipc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\ipc\\bom.ipc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\ipc\\excel.ipc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\ipc\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\ipc\\matrix.ipc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\ipc\\progress.ipc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\ipc\\project.ipc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\ipc\\series.ipc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\ipc\\theme.ipc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\services\\bom-factory.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\services\\bom.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\services\\excel-export\\template-engine.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\services\\export.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\services\\import.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\services\\matrix.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\services\\progress.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\services\\project.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\services\\series.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\main\\services\\theme.service.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\preload\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\App.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\ErrorBoundary.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\dialogs\\AboutDialog.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\dialogs\\BomMetaDialog.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\dialogs\\ChangelogDialog.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  15 |     useEffect(() => {\n  16 |         if (isOpen) {\n> 17 |             setLoading(true)  // 對話框開啟時重置為載入中狀態，屬於語義正確的 Effect 初始化\n     |             ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  18 |             setError(null)\n  19 |             window.api.app.getChangelog()\n  20 |                 .then(result => {","line":17,"column":13,"nodeType":null,"endLine":17,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Dialog from './Dialog'\r\nimport ReactMarkdown from 'react-markdown'\r\nimport { useState, useEffect } from 'react'\r\n\r\n// ========================================\r\n// 更新記錄對話框 (ChangelogDialog)\r\n// 讀取並渲染 CHANGELOG.md\r\n// ========================================\r\n\r\nfunction ChangelogDialog({ isOpen, onClose }) {\r\n    const [content, setContent] = useState('')\r\n    const [loading, setLoading] = useState(true)\r\n    const [error, setError] = useState(null)\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            setLoading(true)  // 對話框開啟時重置為載入中狀態，屬於語義正確的 Effect 初始化\r\n            setError(null)\r\n            window.api.app.getChangelog()\r\n                .then(result => {\r\n                    if (result.success) {\r\n                        setContent(result.data)\r\n                    } else {\r\n                        setError(result.error)\r\n                    }\r\n                })\r\n                .catch(err => setError(err.message))\r\n                .finally(() => setLoading(false))\r\n        }\r\n    }, [isOpen])\r\n\r\n    return (\r\n        <Dialog isOpen={isOpen} onClose={onClose} title=\"更新記錄\" className=\"max-w-2xl\" modal={false}>\r\n            <div className=\"min-h-[300px]\">\r\n                {loading ? (\r\n                    <div className=\"flex items-center justify-center h-full py-20 text-slate-400\">\r\n                        載入中...\r\n                    </div>\r\n                ) : error ? (\r\n                    <div className=\"flex items-center justify-center h-full py-20 text-red-500\">\r\n                        {error}\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"prose prose-sm dark:prose-invert max-w-none\">\r\n                        <ReactMarkdown>{content}</ReactMarkdown>\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </Dialog>\r\n    )\r\n}\r\n\r\nexport default ChangelogDialog\r\n","usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\dialogs\\ConfirmDialog.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\dialogs\\Dialog.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\dialogs\\ImportDialog.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  36 |         if (isOpen && initialFile) {\n  37 |             if (initialFile.path) {\n> 38 |                 setFilePath(initialFile.path)  // 初始化拖曳帶入的檔案路徑，非循環觸發\n     |                 ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  39 |                 setFileName(initialFile.name)\n  40 |             }\n  41 |         }","line":38,"column":17,"nodeType":null,"endLine":38,"endColumn":28}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback, useEffect } from 'react'\r\nimport { Upload, FileSpreadsheet, X } from 'lucide-react'\r\nimport Dialog from './Dialog'\r\n\r\n// ========================================\r\n// Excel 匯入對話框\r\n// 選擇檔案 + 填寫 Phase / Version\r\n// ========================================\r\n\r\n/**\r\n * Excel 匯入對話框元件。\r\n *\r\n * 支援透過按鈕選擇檔案或拖曳 .xls/.xlsx 檔案。\r\n * 使用者需填入 Phase 名稱與版本號後送出匯入。\r\n *\r\n * @param {Object} props\r\n * @param {boolean} props.isOpen - 是否開啟\r\n * @param {Function} props.onClose - 關閉回呼\r\n * @param {number} props.projectId - 目標專案 ID\r\n * @param {string} props.projectCode - 目標專案代碼 (用於顯示與驗證)\r\n * @param {Function} props.onImport - 匯入回呼 (filePath, projectId, phaseName, version) => Promise\r\n * @returns {JSX.Element}\r\n */\r\nfunction ImportDialog({ isOpen, onClose, projectId, projectCode, onImport, initialFile }) {\r\n    const [filePath, setFilePath] = useState('')\r\n    const [fileName, setFileName] = useState('')\r\n    const [phaseName, setPhaseName] = useState('')\r\n    const [version, setVersion] = useState('')\r\n    const [suffix, setSuffix] = useState('')\r\n    const [error, setError] = useState('')\r\n    const [isImporting, setIsImporting] = useState(false)\r\n    const [isDragOver, setIsDragOver] = useState(false)\r\n\r\n    // 處理初始檔案 (來自頁面拖曳)，在對話框開啟時同步帶入預設路徑\r\n    useEffect(() => {\r\n        if (isOpen && initialFile) {\r\n            if (initialFile.path) {\r\n                setFilePath(initialFile.path)  // 初始化拖曳帶入的檔案路徑，非循環觸發\r\n                setFileName(initialFile.name)\r\n            }\r\n        }\r\n    }, [isOpen, initialFile])\r\n\r\n    // 重置表單\r\n    const resetForm = useCallback(() => {\r\n        setFilePath('')\r\n        setFileName('')\r\n        setPhaseName('')\r\n        setVersion('')\r\n        setSuffix('')\r\n        setError('')\r\n        setIsImporting(false)\r\n        setIsDragOver(false)\r\n    }, [])\r\n\r\n    // 開啟檔案選擇對話框\r\n    const handleSelectFile = async () => {\r\n        try {\r\n            const result = await window.api.dialog.showOpen({\r\n                title: '選擇 BOM Excel 檔案',\r\n                filters: [\r\n                    { name: 'Excel Files', extensions: ['xls', 'xlsx'] },\r\n                ],\r\n            })\r\n            if (!result.canceled && result.data) {\r\n                const path = result.data\r\n                setFilePath(path)\r\n                setFileName(path.split(/[\\\\/]/).pop())\r\n                setError('')\r\n            }\r\n        } catch (_e) {\r\n            setError('開啟檔案失敗')\r\n        }\r\n    }\r\n\r\n    // 拖曳處理\r\n    const handleDragOver = (e) => {\r\n        e.preventDefault()\r\n        e.stopPropagation()\r\n        setIsDragOver(true)\r\n    }\r\n\r\n    const handleDragLeave = (e) => {\r\n        e.preventDefault()\r\n        e.stopPropagation()\r\n        setIsDragOver(false)\r\n    }\r\n\r\n    const handleDrop = (e) => {\r\n        e.preventDefault()\r\n        e.stopPropagation()\r\n        setIsDragOver(false)\r\n\r\n        const files = e.dataTransfer?.files\r\n        if (files && files.length > 0) {\r\n            const file = files[0]\r\n            const ext = file.name.split('.').pop()?.toLowerCase()\r\n            if (ext === 'xls' || ext === 'xlsx') {\r\n                const path = window.api.utils.getPathForFile(file)\r\n                setFilePath(path)\r\n                setFileName(file.name)\r\n                setError('')\r\n            } else {\r\n                setError('僅支援 .xls 或 .xlsx 格式')\r\n            }\r\n        }\r\n    }\r\n\r\n    // 送出匯入\r\n    const handleSubmit = async () => {\r\n        if (!filePath) {\r\n            setError('請選擇 Excel 檔案')\r\n            return\r\n        }\r\n        if (!phaseName.trim()) {\r\n            setError('請輸入 Phase 名稱')\r\n            return\r\n        }\r\n        if (!version.trim()) {\r\n            setError('請輸入版本號')\r\n            return\r\n        }\r\n\r\n        setIsImporting(true)\r\n        setError('')\r\n\r\n        try {\r\n            const result = await onImport(filePath, projectId, phaseName.trim(), version.trim())\r\n            if (result.success) {\r\n                resetForm()\r\n                onClose()\r\n            } else {\r\n                setError(result.error || '匯入失敗')\r\n                setIsImporting(false)\r\n            }\r\n        } catch (e) {\r\n            setError(e.message || '匯入失敗')\r\n            setIsImporting(false)\r\n        }\r\n    }\r\n\r\n    // 關閉時重置\r\n    const handleClose = () => {\r\n        resetForm()\r\n        onClose()\r\n    }\r\n\r\n    return (\r\n        <Dialog \r\n            isOpen={isOpen} \r\n            onClose={handleClose} \r\n            title={\r\n                <span>\r\n                    匯入 BOM Excel\r\n                    {projectCode && <span className=\"ml-2 text-primary-600 dark:text-primary-400 font-bold bg-primary-50 dark:bg-primary-900/40 px-2 py-0.5 rounded text-base\">{projectCode}</span>}\r\n                </span>\r\n            } \r\n            className=\"max-w-md\"\r\n        >\r\n            <div className=\"space-y-4\">\r\n                {/* 檔案選擇 / 拖曳區域 */}\r\n                <div\r\n                    onDragOver={handleDragOver}\r\n                    onDragLeave={handleDragLeave}\r\n                    onDrop={handleDrop}\r\n                    onClick={!filePath ? handleSelectFile : undefined}\r\n                    className={`border-2 border-dashed rounded-lg p-4 text-center cursor-pointer transition-colors\r\n                        ${isDragOver\r\n                            ? 'border-primary-400 bg-primary-50 dark:bg-primary-900/20'\r\n                            : filePath\r\n                                ? 'border-green-300 bg-green-50/50 dark:border-green-700 dark:bg-green-900/10'\r\n                                : 'border-slate-300 dark:border-slate-600 hover:border-primary-300 dark:hover:border-primary-600'\r\n                        }`}\r\n                >\r\n                    {filePath ? (\r\n                        <div className=\"flex items-center justify-center gap-2\">\r\n                            <FileSpreadsheet size={20} className=\"text-green-600\" />\r\n                            <span className=\"text-sm text-slate-700 dark:text-slate-300 font-medium truncate max-w-[260px]\">\r\n                                {fileName}\r\n                            </span>\r\n                            <button\r\n                                onClick={(e) => {\r\n                                    e.stopPropagation()\r\n                                    setFilePath('')\r\n                                    setFileName('')\r\n                                }}\r\n                                className=\"p-0.5 rounded hover:bg-slate-200 dark:hover:bg-surface-600 text-slate-400\"\r\n                            >\r\n                                <X size={14} />\r\n                            </button>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"space-y-1 text-slate-400\">\r\n                            <Upload size={24} className=\"mx-auto\" />\r\n                            <p className=\"text-sm\">點擊選擇檔案或拖曳 .xls / .xlsx</p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Phase 名稱 */}\r\n                <div>\r\n                    <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1\">\r\n                        Phase 名稱 <span className=\"text-red-500\">*</span>\r\n                    </label>\r\n                    <input\r\n                        type=\"text\"\r\n                        value={phaseName}\r\n                        onChange={(e) => setPhaseName(e.target.value.toUpperCase())}\r\n                        placeholder=\"例：EVT, SI, DB\"\r\n                        className=\"w-full px-3 py-2 text-sm\r\n                            bg-white dark:bg-surface-900\r\n                            border border-slate-300 dark:border-slate-600\r\n                            rounded-lg text-slate-800 dark:text-slate-200\r\n                            focus:outline-none focus:ring-2 focus:ring-primary-500\r\n                            placeholder:text-slate-400\"\r\n                    />\r\n                </div>\r\n\r\n                {/* 版本號 */}\r\n                <div>\r\n                    <div className=\"space-y-1\">\r\n                        <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1\">\r\n                            版本 (Version) <span className=\"text-red-500\">*</span>\r\n                        </label>\r\n                        <input\r\n                            type=\"text\"\r\n                            value={version}\r\n                            onChange={(e) => setVersion(e.target.value)}\r\n                            placeholder=\"e.g. 0.1, 1.0\"\r\n                            className=\"w-full px-3 py-2 text-sm\r\n                                bg-white dark:bg-surface-800\r\n                                border border-slate-300 dark:border-slate-600\r\n                                rounded-lg text-slate-800 dark:text-slate-200\r\n                                focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                        />\r\n                    </div>\r\n\r\n                    <div className=\"space-y-1 mt-4\"> {/* Added mt-4 for spacing between Version and Suffix */}\r\n                        <label className=\"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1\">\r\n                            後綴 (Suffix) <span className=\"text-xs text-slate-400 font-normal\">(選填)</span>\r\n                        </label>\r\n                        <input\r\n                            type=\"text\"\r\n                            value={suffix}\r\n                            onChange={(e) => setSuffix(e.target.value)}\r\n                            placeholder=\"e.g. A, B, Test\"\r\n                            className=\"w-full px-3 py-2 text-sm\r\n                                bg-white dark:bg-surface-800\r\n                                border border-slate-300 dark:border-slate-600\r\n                                rounded-lg text-slate-800 dark:text-slate-200\r\n                                focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                {/* 錯誤訊息 */}\r\n                {error && (\r\n                    <p className=\"text-sm text-red-600 dark:text-red-400\">{error}</p>\r\n                )}\r\n\r\n                {/* 操作按鈕 */}\r\n                <div className=\"flex justify-end gap-2 pt-1\">\r\n                    <button\r\n                        onClick={handleClose}\r\n                        disabled={isImporting}\r\n                        className=\"px-4 py-2 text-sm font-medium text-slate-600 dark:text-slate-300\r\n                            bg-slate-100 dark:bg-surface-700 hover:bg-slate-200 dark:hover:bg-surface-600\r\n                            rounded-lg transition-colors disabled:opacity-50\"\r\n                    >\r\n                        取消\r\n                    </button>\r\n                    <button\r\n                        onClick={handleSubmit}\r\n                        disabled={isImporting}\r\n                        className=\"px-4 py-2 text-sm font-medium text-white\r\n                            bg-primary-600 hover:bg-primary-700\r\n                            rounded-lg transition-colors disabled:opacity-50\"\r\n                    >\r\n                        {isImporting ? '匯入中...' : '匯入'}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </Dialog>\r\n    )\r\n}\r\n\r\nexport default ImportDialog\r\n","usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\dialogs\\MatrixModelDialog.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\dialogs\\ProgressDialog.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\dialogs\\ProjectDialog.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\layout\\AppLayout.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\layout\\AppStatusLine.jsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  24 |         } else {\n  25 |             // eslint-disable-next-line react-hooks/set-state-in-effect\n> 26 |             setVersion('dev')  // API 不存在時（開發環境備用），一次性初始化\n     |             ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  27 |         }\n  28 |     }, [])\n  29 |","line":26,"column":13,"nodeType":null,"endLine":26,"endColumn":23,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\layout\\BomSidebar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\layout\\Sidebar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\layout\\StatusBar.jsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  26 |         } else {\n  27 |             // eslint-disable-next-line react-hooks/set-state-in-effect\n> 28 |             setVersion('dev')  // API 不存在時（開發環境備用），一次性初始化\n     |             ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  29 |         }\n  30 |     }, [])\n  31 |","line":28,"column":13,"nodeType":null,"endLine":28,"endColumn":23,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\components\\tables\\BomTable.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'toggleGroup' function makes the dependencies of useMemo Hook (at line 543) change on every render. Move it inside the useMemo callback. Alternatively, wrap the definition of 'toggleGroup' in its own useCallback() Hook.","line":133,"column":11,"nodeType":"VariableDeclarator","endLine":140,"endColumn":6},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'toggleAll' function makes the dependencies of useMemo Hook (at line 543) change on every render. Move it inside the useMemo callback. Alternatively, wrap the definition of 'toggleAll' in its own useCallback() Hook.","line":142,"column":11,"nodeType":"VariableDeclarator","endLine":150,"endColumn":6},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'handleMatrixSelection' function makes the dependencies of useMemo Hook (at line 543) change on every render. Move it inside the useMemo callback. Alternatively, wrap the definition of 'handleMatrixSelection' in its own useCallback() Hook.","line":153,"column":11,"nodeType":"VariableDeclarator","endLine":171,"endColumn":6}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo, useRef, useState, useEffect } from 'react'\r\nimport {\r\n    useReactTable,\r\n    getCoreRowModel,\r\n    flexRender,\r\n} from '@tanstack/react-table'\r\nimport { useVirtualizer } from '@tanstack/react-virtual'\r\nimport { \r\n    ChevronsUpDown, // All Expanded (or toggle)\r\n    ChevronsDown,   // All Collapsed (Expand All)\r\n    ListMinus,       // Partical\r\n    ChevronRight, ChevronDown as ChevronDownIcon,\r\n    CheckCircle2\r\n} from 'lucide-react'\r\nimport useMatrixStore from '../../stores/useMatrixStore'\r\n\r\n\r\n// ========================================\r\n// 搜尋高亮輔助元件\r\n// ========================================\r\nconst HighlightText = ({ text, term }) => {\r\n    if (!term || !text) return text\r\n    \r\n    const parts = String(text).split(new RegExp(`(${term})`, 'gi'))\r\n    return (\r\n        <span>\r\n            {parts.map((part, i) => \r\n                part.toLowerCase() === term.toLowerCase() ? (\r\n                    <span key={i} className=\"bg-yellow-200 text-slate-800 dark:bg-yellow-600/50 dark:text-white rounded px-0.5\">{part}</span>\r\n                ) : (\r\n                    part\r\n                )\r\n            )}\r\n        </span>\r\n    )\r\n}\r\n\r\n\r\nfunction BomTable(props) {\r\n    const { data, isLoading, searchTerm, searchFields, mode } = props;\r\n    // --- Context / Store ---\r\n    const {\r\n        matrixData,\r\n        saveSelection,\r\n        deleteSelection\r\n    } = useMatrixStore()\r\n\r\n    // Matrix Data Lookup\r\n    // Since `matrixData` is stored by key (single ID or 'multi'), we need to access it correctly.\r\n    // If mode is MATRIX and we have data, we assume matrixData has been fetched for current selection.\r\n    // We'll iterate over all keys in matrixData or rely on a \"current\" pointer?\r\n    // Actually, `useMatrixStore` stores data by `bomRevisionId`.\r\n    // If multiple BOMs are selected, `matrixData` might have 'multi' key.\r\n    // Let's assume the page triggers fetch and stores in a predictable key.\r\n    // However, `matrixData` structure is `{ [key]: { models, selections } }`.\r\n    // If we have dynamic columns from potentially multiple BOMs, we need to merge them.\r\n    // For simplicity, let's assume `useMatrixStore` exposes a `currentMatrixData` selector or we use the `matrixData` directly.\r\n\r\n    // Derived Matrix Data\r\n    const matrixInfo = useMemo(() => {\r\n        if (mode !== 'MATRIX') return null;\r\n\r\n        // Aggregate models and selections from all loaded matrix data that matches current view rows?\r\n        // Or simpler: `useMatrixStore` should have been called with the current selection IDs.\r\n        // If single BOM: key is ID. If multi: key is 'multi' (as per my update).\r\n        // Let's try to find the data.\r\n        // Since I don't have the key here easily without passing it, I might iterate `matrixData` values?\r\n        // No, `fetchMatrixData` was called with specific IDs.\r\n        // Let's assume the parent passes `matrixKey` or `matrixData` directly?\r\n        // Passing `matrixData` directly from Store to Component might be cleaner.\r\n        // But `useMatrixStore` is global.\r\n\r\n        // Hack: Check if 'multi' exists, else check single ID if data length > 0\r\n        // Ideally `useBomStore` knows the selected IDs.\r\n        // Let's try to grab 'multi' if it exists, else look for single.\r\n\r\n        let data = matrixData['multi'];\r\n        if (!data) {\r\n            // Find any single key\r\n            const keys = Object.keys(matrixData).filter(k => k !== 'multi');\r\n            if (keys.length === 1) {\r\n                data = matrixData[keys[0]];\r\n            }\r\n        }\r\n        return data;\r\n    }, [matrixData, mode]);\r\n\r\n    const models = useMemo(() => matrixInfo?.models || [], [matrixInfo?.models]);\r\n    const selections = useMemo(() => matrixInfo?.selections || [], [matrixInfo?.selections]);\r\n    const summary = useMemo(() => matrixInfo?.summary || {}, [matrixInfo?.summary]);\r\n\r\n    // Selection Map\r\n    const selectionMap = useMemo(() => {\r\n        const map = new Map();\r\n        selections.forEach(s => {\r\n            map.set(`${s.matrix_model_id}|${s.group_key}`, s);\r\n        });\r\n        return map;\r\n    }, [selections]);\r\n\r\n\r\n    // 收合狀態\r\n    const [expandedGroups, setExpandedGroups] = useState(new Set())\r\n    const [sorting, setSorting] = useState([])\r\n\r\n    // 取得所有具有 2nd Source 的 Group Key\r\n    const allGroupKeys = useMemo(() => {\r\n        if (!data) return new Set()\r\n        const keys = new Set()\r\n        data.forEach(item => {\r\n            if (item.second_sources && item.second_sources.length > 0) {\r\n                keys.add(`${item.supplier}|${item.supplier_pn}`)\r\n            }\r\n        })\r\n        return keys\r\n    }, [data])\r\n\r\n    // 初始化：預設全部展開\r\n    useEffect(() => {\r\n        setExpandedGroups(allGroupKeys)\r\n    }, [allGroupKeys])\r\n\r\n    // 衍生狀態\r\n    const totalGroups = allGroupKeys.size\r\n    const expandedCount = expandedGroups.size\r\n    \r\n    let expandState = 'ALL_EXPANDED' // default\r\n    if (totalGroups > 0) {\r\n        if (expandedCount === 0) expandState = 'ALL_COLLAPSED'\r\n        else if (expandedCount < totalGroups) expandState = 'PARTIAL'\r\n    }\r\n\r\n    const toggleGroup = (key) => {\r\n        setExpandedGroups(prev => {\r\n            const next = new Set(prev)\r\n            if (next.has(key)) next.delete(key)\r\n            else next.add(key)\r\n            return next\r\n        })\r\n    }\r\n\r\n    const toggleAll = () => {\r\n        if (expandState === 'ALL_EXPANDED') {\r\n            // Collapse All\r\n            setExpandedGroups(new Set())\r\n        } else {\r\n            // Expand All (for both Collapsed and Partial)\r\n            setExpandedGroups(allGroupKeys)\r\n        }\r\n    }\r\n\r\n    // Matrix Handler\r\n    const handleMatrixSelection = async (modelId, groupKey, type, id, isCurrentlySelected) => {\r\n        // Use current view context IDs for refresh\r\n        // Get selected IDs from BomStore? Or pass as prop?\r\n        // Let's pass `viewContextIds` as prop or use `useBomStore`?\r\n        // `BomTable` doesn't know about `selectedRevisionIds` unless passed.\r\n        // Let's add `viewContextIds` prop to `BomTable`.\r\n        const contextIds = props.viewContextIds;\r\n\r\n        if (isCurrentlySelected) {\r\n            await deleteSelection(contextIds, modelId, groupKey);\r\n        } else {\r\n            await saveSelection(contextIds, {\r\n                matrix_model_id: modelId,\r\n                group_key: groupKey,\r\n                selected_type: type,\r\n                selected_id: id\r\n            });\r\n        }\r\n    };\r\n\r\n    // 將聚合資料展開為平面行列\r\n    const flatRows = useMemo(() => {\r\n        if (isLoading) return [] \r\n        \r\n        let processedData = [...data]\r\n\r\n        // 1. 執行排序 (僅針對 Main Items)\r\n        if (sorting.length > 0) {\r\n            const { id, desc } = sorting[0]\r\n            processedData.sort((a, b) => {\r\n                let valA = a[id]\r\n                let valB = b[id]\r\n                if (valA === null || valA === undefined) valA = ''\r\n                if (valB === null || valB === undefined) valB = ''\r\n                if (typeof valA === 'string') valA = valA.toLowerCase()\r\n                if (typeof valB === 'string') valB = valB.toLowerCase()\r\n\r\n                if (valA < valB) return desc ? 1 : -1\r\n                if (valA > valB) return desc ? -1 : 1\r\n                return 0\r\n            })\r\n        }\r\n\r\n        // 2. 展開為平面結構\r\n        const rows = []\r\n        let groupIndex = 0\r\n        processedData.forEach((mainItem) => {\r\n            const key = `${mainItem.supplier}|${mainItem.supplier_pn}`\r\n            const hasSecondSources = mainItem.second_sources?.length > 0\r\n            const isExpanded = expandedGroups.has(key)\r\n            \r\n            // Main Item 行\r\n            rows.push({\r\n                ...mainItem,\r\n                location: mainItem.locations,\r\n                _rowType: 'main',\r\n                _groupIndex: groupIndex,\r\n                _key: key,\r\n                _hasSecondSources: hasSecondSources,\r\n                _isExpanded: isExpanded,\r\n            })\r\n            \r\n            // 2nd Source 行\r\n            if (hasSecondSources && isExpanded) {\r\n                mainItem.second_sources.forEach((ss) => {\r\n                    rows.push({\r\n                        ...ss,\r\n                        location: '',\r\n                        _rowType: 'second',\r\n                        _groupIndex: groupIndex,\r\n                        _key: key, // Keep key for Matrix selection mapping\r\n                        bom_status: mainItem.bom_status,\r\n                        type: mainItem.type,\r\n                        locations: undefined,\r\n                        quantity: '',\r\n                        ccl: '',\r\n                        remark: '',\r\n                        // Needed for Matrix selection to identify row correctly\r\n                        bom_revision_id: ss.bom_revision_id || mainItem.bom_revision_id,\r\n                    })\r\n                })\r\n            }\r\n            groupIndex++\r\n        })\r\n        return rows\r\n    }, [data, isLoading, sorting, expandedGroups])\r\n\r\n    // 欄位定義\r\n    const columns = useMemo(() => {\r\n        const baseCols = [\r\n            {\r\n                id: 'rowIndicator',\r\n                header: () => {\r\n                    // Determine Icon based on expandState\r\n                    let Icon = ChevronsUpDown // Default (ALL_EXPANDED) logic\r\n\r\n\r\n                    if (expandState === 'ALL_EXPANDED') Icon = ChevronsUpDown\r\n                    else if (expandState === 'ALL_COLLAPSED') Icon = ChevronsDown\r\n                    else if (expandState === 'PARTIAL') Icon = ListMinus\r\n\r\n                    return (\r\n                        <div \r\n                            onClick={(e) => { e.stopPropagation(); toggleAll(); }}\r\n                            className=\"cursor-pointer hover:text-primary-600 select-none flex items-center justify-center w-full h-full p-1\"\r\n                            title={expandState === 'ALL_EXPANDED' ? \"點擊全部收合\" : \"點擊全部展開\"}\r\n                        >\r\n                            <Icon size={16} className=\"text-slate-500\" />\r\n                        </div>\r\n                    )\r\n                },\r\n                size: 60,\r\n                cell: ({ row }) => {\r\n                    const r = row.original\r\n                    if (r._rowType === 'main') {\r\n                        return (\r\n                            <div\r\n                                className=\"flex items-center gap-1 cursor-pointer select-none pl-1\"\r\n                                onClick={(e) => {\r\n                                    if (r._hasSecondSources) {\r\n                                        e.stopPropagation()\r\n                                        toggleGroup(r._key)\r\n                                    }\r\n                                }}\r\n                            >\r\n                                 {/* Text: Main. No emphasis color (slate-600). */}\r\n                                <span className=\"text-[10px] text-slate-600 font-bold\" title=\"Main Source\">Main</span>\r\n\r\n                                {/* Icon: Show if has 2nd sources */}\r\n                                {r._hasSecondSources && (\r\n                                    <span className=\"text-slate-400\">\r\n                                        {r._isExpanded ? <ChevronDownIcon size={12}/> : <ChevronRight size={12}/>}\r\n                                    </span>\r\n                                )}\r\n                            </div>\r\n                        )\r\n                    }\r\n                    return null\r\n                },\r\n            },\r\n            {\r\n                accessorKey: 'hhpn',\r\n                header: 'HHPN',\r\n                cell: ({ getValue }) => <HighlightText text={getValue()} term={searchFields?.has('hhpn') ? searchTerm : ''} />\r\n            },\r\n            {\r\n                accessorKey: 'description',\r\n                header: 'Description',\r\n                size: 500, // Large logical size to encourage taking space\r\n                cell: ({ getValue }) => (\r\n                    <span className=\"truncate block w-full\" title={getValue()}>\r\n                        <HighlightText text={getValue()} term={searchFields?.has('description') ? searchTerm : ''} />\r\n                    </span>\r\n                ),\r\n            },\r\n            {\r\n                accessorKey: 'supplier',\r\n                header: 'Supplier',\r\n                cell: ({ getValue }) => <HighlightText text={getValue()} term={searchFields?.has('supplier') ? searchTerm : ''} />\r\n            },\r\n            {\r\n                accessorKey: 'supplier_pn',\r\n                header: 'Supplier PN',\r\n                cell: ({ getValue }) => <HighlightText text={getValue()} term={searchFields?.has('supplier_pn') ? searchTerm : ''} />\r\n            },\r\n        ];\r\n\r\n        // Standard BOM Columns\r\n        const standardCols = [\r\n            {\r\n                accessorKey: 'location',\r\n                header: 'Location',\r\n                size: 200,\r\n                cell: ({ row }) => {\r\n                    if (row.original._rowType === 'second') return ''\r\n                    const loc = row.original.location || ''\r\n                    return (\r\n                        <span className=\"truncate block\" title={loc}>\r\n                            <HighlightText text={loc} term={searchFields?.has('location') ? searchTerm : ''} />\r\n                        </span>\r\n                    )\r\n                },\r\n            },\r\n            {\r\n                accessorKey: 'quantity',\r\n                header: 'Qty',\r\n                size: 40,\r\n                cell: ({ row }) => {\r\n                    if (row.original._rowType === 'second') return ''\r\n                    return row.original.quantity\r\n                },\r\n            },\r\n            {\r\n                accessorKey: 'bom_status',\r\n                header: 'BOM',\r\n                size: 40,\r\n                cell: ({ row }) => {\r\n                    if (row.original._rowType === 'second') return ''\r\n                    const s = row.original.bom_status\r\n                    const colorMap = { I: 'text-green-600', X: 'text-red-500', P: 'text-amber-600', M: 'text-blue-600' }\r\n                    return <span className={`font-semibold ${colorMap[s] || ''}`}>{s}</span>\r\n                },\r\n            },\r\n            {\r\n                accessorKey: 'type',\r\n                header: 'Type',\r\n                size: 60,\r\n                cell: ({ row }) => {\r\n                    if (row.original._rowType === 'second') return ''\r\n                    return row.original.type || ''\r\n                },\r\n            },\r\n            {\r\n                accessorKey: 'ccl',\r\n                header: 'CCL',\r\n                size: 35,\r\n                cell: ({ row }) => {\r\n                    if (row.original._rowType === 'second') return ''\r\n                    const c = row.original.ccl\r\n                    if (c === 'Y') return <span className=\"text-red-500 font-bold\">Y</span>\r\n                    return c || ''\r\n                },\r\n            },\r\n            {\r\n                accessorKey: 'remark',\r\n                header: 'Remark',\r\n                size: 100,\r\n                cell: ({ row }) => {\r\n                    if (row.original._rowType === 'second') return ''\r\n                    const remark = row.original.remark || ''\r\n                    return (\r\n                        <span className=\"truncate block\" title={remark}>\r\n                            <HighlightText text={remark} term={searchFields?.has('remark') ? searchTerm : ''} />\r\n                        </span>\r\n                    )\r\n                },\r\n            },\r\n        ];\r\n\r\n        // Matrix Columns (Grouped by Project)\r\n        // Note: models now contain `bom_revision_id`. We need to group them by project.\r\n        // But `matrixData` comes from backend and `models` is flat list.\r\n        // We need Project Code info. Backend `getMatrixData` should probably return project info or we infer it.\r\n        // Current `models` structure: { id, bom_revision_id, name, description }\r\n        // We need map `bom_revision_id` -> `Project Code`.\r\n        // `useBomStore` has `revisions`? Or `BomSidebar` loads them.\r\n        // Let's assume we can group by `bom_revision_id` and use `bom_revision_id` as header group?\r\n        // TanStack Table supports header grouping.\r\n        // Structure:\r\n        // Project A (Header Group) -> [Model A, Model B] (Columns)\r\n        // Project B (Header Group) -> [Model A] (Columns)\r\n\r\n        // 1. Group models by BOM Revision ID (which acts as proxy for Project Phase/Version)\r\n        // Better: Group by Project Code. But we might not have project code in `models`.\r\n        // Let's iterate models and build columns.\r\n\r\n        const matrixCols = [];\r\n        if (mode === 'MATRIX') {\r\n            // Group models by bom_revision_id\r\n            const groupedModels = {};\r\n            models.forEach(m => {\r\n                if (!groupedModels[m.bom_revision_id]) groupedModels[m.bom_revision_id] = [];\r\n                groupedModels[m.bom_revision_id].push(m);\r\n            });\r\n\r\n            // Need to fetch BOM info to display Project Name?\r\n            // We don't have it here easily.\r\n            // Workaround: Use `bom_revision_id` temporarily or assume `models` has extra info.\r\n            // Ideally Backend should enrich `models` with `project_code` or `phase_name`.\r\n            // For now, let's just list them flattened but grouped if TanStack supports dynamic groups easily.\r\n            // Dynamic grouping in TanStack Table requires nested columns structure.\r\n\r\n            // Let's try flat columns first with header indicating project?\r\n            // \"Project A - Model A\"\r\n            // Or better: Update backend to return project info in models.\r\n            // Assuming backend update will happen in next step (as per plan).\r\n            // I will implement Grouped Columns logic assuming `model.project_code` exists or similar.\r\n\r\n            // If backend hasn't updated yet, we use placeholder.\r\n            Object.entries(groupedModels).forEach(([bomId, bomModels]) => {\r\n                // Find project info?\r\n                // Let's assume models have `project_code` and `phase_name` (added in next backend step).\r\n                const firstModel = bomModels[0];\r\n                const headerTitle = firstModel.project_code\r\n                    ? `${firstModel.project_code} (${firstModel.phase_name})`\r\n                    : `BOM ${bomId}`;\r\n\r\n                const groupCol = {\r\n                    id: `bom_group_${bomId}`,\r\n                    meta: { isFirstOfGroup: true }, // 頂層分組也標記為第一欄，以顯示分隔線\r\n                    header: () => (\r\n                        <div className=\"w-full text-center\">\r\n                            {headerTitle}\r\n                        </div>\r\n                    ),\r\n                    columns: bomModels.map((model, idx) => {\r\n                        const status = summary.modelStatus?.[model.id] || {};\r\n                        const isComplete = status.isComplete;\r\n                        \r\n                        return {\r\n                            id: `model_${model.id}`,\r\n                            meta: { \r\n                                isComplete, \r\n                                isFirstOfGroup: idx === 0 // 標記是否為專案分組的第一欄\r\n                            },\r\n                            header: () => {\r\n                                return (\r\n                                    <div className=\"flex flex-col items-center justify-center py-0.5 text-center px-1\" title={model.description}>\r\n                                        <div className=\"flex flex-col items-center gap-0.5\">\r\n                                            <span className=\"truncate max-w-[90px]\">{model.name}</span>\r\n                                            {isComplete && (\r\n                                                <CheckCircle2 size={11} className=\"text-green-500 flex-shrink-0\" />\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                );\r\n                            },\r\n                        size: 100,\r\n                        cell: ({ row }) => {\r\n                            const r = row.original;\r\n                            const groupKey = r._key;\r\n                            const rowType = r._rowType === 'main' ? 'part' : 'second_source';\r\n                            const rowId = r.id;\r\n\r\n                            // Only render checkbox if this row belongs to this BOM (for Union View)\r\n                            // or if it's a \"Union Row\" (exists in multiple).\r\n                            // Current `executeView` returns UNION of parts.\r\n                            // If a part exists in BOM A but not BOM B, should BOM B column show checkbox?\r\n                            // Requirement: \"不屬於該專案的物料, 儲存格以disable的效果呈現 (讓user知道這專案沒有用到這物料)\"\r\n                            // So we need to know if this row \"exists\" in this BOM.\r\n                            // `row` object from `executeView` (Union) should have info about which BOMs it belongs to?\r\n                            // Currently `executeView` aggregates by Supplier+PN.\r\n                            // If we have multiple BOMs, `quantity` etc might be ambiguous.\r\n                            // The `executeView` union logic needs to provide `existsInBomIds` array?\r\n                            // Or we check `bom_revision_id`?\r\n                            // If `executeView` returns one row per unique part, `bom_revision_id` is ambiguous (it picks first).\r\n                            // We need `bom_ids` array in the row data!\r\n\r\n                            // Assuming backend updates `executeView` to include `bom_ids` array.\r\n                            const existsInBom = r.bom_ids?.includes(model.bom_revision_id);\r\n\r\n                            if (!existsInBom && r.bom_ids) {\r\n                                return <div className=\"h-full w-full bg-slate-100 dark:bg-slate-800/50\" title=\"此專案無此物料\" />;\r\n                            }\r\n\r\n                            // Selection check\r\n                            const selection = selectionMap.get(`${model.id}|${groupKey}`);\r\n                            const isSelected = selection &&\r\n                                               selection.selected_type === rowType &&\r\n                                               selection.selected_id === rowId;\r\n\r\n                            const isImplicit = isSelected && selection.is_implicit;\r\n                            const isExplicit = isSelected && !selection.is_implicit;\r\n                            const isGroupComplete = !!selection;\r\n                            const showWarning = !isGroupComplete && r._rowType === 'main';\r\n\r\n                            return (\r\n                                <div className={`flex items-center justify-center h-full w-full ${showWarning ? 'bg-amber-50 dark:bg-amber-900/20 box-border border-2 border-amber-300 dark:border-amber-600' : ''}`}>\r\n                                    <input\r\n                                        type=\"checkbox\"\r\n                                        checked={!!isSelected}\r\n                                        disabled={isImplicit}\r\n                                        onChange={() => !isImplicit && handleMatrixSelection(model.id, groupKey, rowType, rowId, isExplicit)}\r\n                                        className={`w-4 h-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500 cursor-pointer disabled:opacity-50 ${isImplicit ? 'cursor-not-allowed' : ''}`}\r\n                                        title={isImplicit ? \"自動選中 (唯一選項)\" : \"\"}\r\n                                    />\r\n                                </div>\r\n                            );\r\n                        }\r\n                    };\r\n                })\r\n                };\r\n                matrixCols.push(groupCol);\r\n            });\r\n        }\r\n\r\n        // In Matrix Mode, we replace Standard Cols?\r\n        // User said: \"supplier PN 之前的欄位都維持不變, 後面接著是專案的model selection欄位\"\r\n        // So we append matrixCols AFTER Supplier PN.\r\n        // Base Cols ends at Supplier PN.\r\n        // So we split standardCols?\r\n        // Wait, current baseCols includes HHPN, Desc, Supplier, Supplier PN.\r\n        // standardCols has Location, Qty, BOM, Type, CCL, Remark.\r\n\r\n        if (mode === 'MATRIX') {\r\n            return [...baseCols, ...matrixCols];\r\n        } else {\r\n            return [...baseCols, ...standardCols];\r\n        }\r\n\r\n    }, [expandState, toggleAll, toggleGroup, searchTerm, searchFields, mode, models, summary, selectionMap, handleMatrixSelection])\r\n\r\n    // TanStack Table 實例\r\n    const table = useReactTable({\r\n        data: flatRows,\r\n        columns,\r\n        getCoreRowModel: getCoreRowModel(),\r\n        state: {\r\n            sorting,\r\n        },\r\n        onSortingChange: setSorting,\r\n        manualSorting: true, // We sort the data manually in useMemo to preserve grouping\r\n    })\r\n    \r\n    // 虛擬捲動\r\n    const tableContainerRef = useRef(null)\r\n    const rowVirtualizer = useVirtualizer({\r\n        count: table.getRowModel().rows.length,\r\n        getScrollElement: () => tableContainerRef.current,\r\n        estimateSize: () => 35, // 預估行高\r\n        overscan: 10,\r\n    })\r\n\r\n    const virtualItems = rowVirtualizer.getVirtualItems()\r\n    const totalSize = rowVirtualizer.getTotalSize()\r\n\r\n    const paddingTop = virtualItems.length > 0 ? virtualItems[0].start : 0\r\n    const paddingBottom = virtualItems.length > 0 ? totalSize - (virtualItems[virtualItems.length - 1]?.end || 0) : 0\r\n\r\n    // ========================================\r\n    // 渲染：無資料提示 (僅在非載入中且無資料時顯示)\r\n    // ========================================\r\n    if (!isLoading && data.length === 0) {\r\n        return (\r\n            <div className=\"flex items-center justify-center h-64 text-sm text-slate-400 dark:text-slate-500\">\r\n                無資料 ... \r\n            </div>\r\n        )\r\n    }\r\n\r\n    // ========================================\r\n    // 渲染：表格\r\n    // ========================================\r\n    return (\r\n        <div ref={tableContainerRef} className=\"h-full overflow-auto border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-surface-800 relative\">\r\n            <table className=\"w-full text-xs border-collapse relative\">\r\n                {/* 表頭 (Sticky) */}\r\n                <thead className=\"sticky top-0 z-10 shadow-sm\">\r\n                    {table.getHeaderGroups().map((headerGroup, index) => (\r\n                        <tr key={headerGroup.id}>\r\n                            {headerGroup.headers.map((header) => {\r\n                                // 在 Matrix 模式下，處理基礎欄位的合併 (rowSpan)\r\n                                // 如果是第一層 (index 0) 且該欄位沒有子欄位 (isPlaceholder 為假)，則讓他跨兩行\r\n                                const isMatrix = mode === 'MATRIX'\r\n                                const isFirstGroup = index === 0\r\n                                const isLeaf = !header.column.columnDef.columns\r\n                                \r\n                                // 如果在第二層以後：\r\n                                // 1. 如果是佔位符 (代表他在上面的層級已經被 rowSpan 處理過)，則不渲染\r\n                                // 2. 在 Matrix 模式下，第二層只應該顯示屬於分組內 (有 parent) 的欄位\r\n                                if (isMatrix && !isFirstGroup) {\r\n                                    if (header.isPlaceholder || !header.column.parent) {\r\n                                        return null\r\n                                    }\r\n                                }\r\n\r\n                                const rowSpan = (isMatrix && isFirstGroup && isLeaf) ? 2 : 1\r\n                                const colSpan = header.colSpan\r\n                                const isSorted = header.column.getIsSorted()\r\n\r\n                                // 警告樣式邏輯\r\n                                const meta = header.column.columnDef.meta\r\n                                const isUnfinishedModel = isMatrix && !isFirstGroup && meta && meta.isComplete === false\r\n                                \r\n                                // 分隔線邏輯：Matrix 模式下，每個分組的第一個欄位左側加深框線\r\n                                const hasLeftDivider = isMatrix && meta?.isFirstOfGroup\r\n\r\n                                return (\r\n                                    <th\r\n                                        key={header.id}\r\n                                        colSpan={colSpan}\r\n                                        rowSpan={rowSpan}\r\n                                        onClick={header.column.getToggleSortingHandler()}\r\n                                        className={`text-left text-[11px] font-semibold\r\n                                            py-1.5 px-2 border-b border-slate-200 dark:border-slate-600\r\n                                            whitespace-nowrap select-none bg-clip-padding\r\n                                            ${isUnfinishedModel \r\n                                                ? 'bg-slate-50 dark:bg-surface-800 text-amber-600 dark:text-amber-400' \r\n                                                : 'bg-slate-50 dark:bg-surface-800 text-bom-header-text'}\r\n                                            ${hasLeftDivider ? 'border-l-2 border-slate-300 dark:border-slate-500' : ''}\r\n                                            ${header.column.getCanSort() ? 'cursor-pointer hover:text-slate-700 dark:hover:text-slate-200' : ''}`}\r\n                                        style={{ width: header.getSize() }}\r\n                                    >\r\n                                        <div className={`flex items-center gap-1 ${!isFirstGroup && isMatrix ? 'justify-center' : ''}`}>\r\n                                            {flexRender(header.column.columnDef.header, header.getContext())}\r\n                                            {{\r\n                                                asc: ' 🔼',\r\n                                                desc: ' 🔽',\r\n                                            }[isSorted] ?? null}\r\n                                        </div>\r\n                                    </th>\r\n                                )\r\n                            })}\r\n                        </tr>\r\n                    ))}\r\n                </thead>\r\n\r\n                {/* 表身 */}\r\n                <tbody>\r\n                    {isLoading ? (\r\n                        // 骨架屏 (Skeleton Rows)\r\n                        Array.from({ length: 20 }).map((_, idx) => (\r\n                            <tr key={idx} className=\"border-b border-slate-100 dark:border-slate-700/50\">\r\n                                {columns.map((col, cIdx) => (\r\n                                    <td key={cIdx} className=\"py-2 px-2\">\r\n                                        <div className={`h-3 rounded bg-slate-200 dark:bg-surface-600 animate-pulse ${\r\n                                            cIdx === 4 ? 'w-32' : cIdx === 6 ? 'w-24' : 'w-full'\r\n                                        }`} />\r\n                                    </td>\r\n                                ))}\r\n                            </tr>\r\n                        ))\r\n                    ) : (\r\n                        // 虛擬化資料列\r\n                        <>\r\n                            {paddingTop > 0 && (\r\n                                <tr>\r\n                                    <td colSpan={columns.length} style={{ height: `${paddingTop}px` }} />\r\n                                </tr>\r\n                            )}\r\n                            {virtualItems.map((virtualRow) => {\r\n                                const row = table.getRowModel().rows[virtualRow.index]\r\n                                const r = row.original\r\n                                const isSecond = r._rowType === 'second'\r\n                                const isEvenGroup = r._groupIndex % 2 === 0\r\n\r\n                                let rowClass = ''\r\n                                // 採用 Semantic Class (定義於 index.css & theme 檔案)\r\n                                if (isEvenGroup) {\r\n                                    // 偶數群組\r\n                                    rowClass = isSecond\r\n                                        ? 'bg-bom-row-second-even text-bom-text-second'\r\n                                        : 'bg-bom-row-main-even text-bom-text-main'\r\n                                } else {\r\n                                    // 奇數群組\r\n                                    rowClass = isSecond\r\n                                        ? 'bg-bom-row-second-odd text-bom-text-second'\r\n                                        : 'bg-bom-row-main-odd text-bom-text-main'\r\n                                }\r\n\r\n                                return (\r\n                                    <tr\r\n                                        key={row.id}\r\n                                        data-index={virtualRow.index}\r\n                                        ref={rowVirtualizer.measureElement}\r\n                                        className={`${rowClass} border-b border-slate-100 dark:border-slate-700/50\r\n                                            hover:bg-bom-row-hover transition-colors`}\r\n                                    >\r\n                                        {row.getVisibleCells().map((cell) => {\r\n                                            const cellMeta = cell.column.columnDef.meta;\r\n                                            const hasLeftDivider = mode === 'MATRIX' && cellMeta?.isFirstOfGroup;\r\n                                            \r\n                                            return (\r\n                                                <td\r\n                                                    key={cell.id}\r\n                                                    className={`py-1 px-2\r\n                                                        ${isSecond ? 'italic' : ''}\r\n                                                        ${hasLeftDivider ? 'border-l-2 border-slate-200 dark:border-slate-700' : ''}\r\n                                                        whitespace-nowrap overflow-hidden`}\r\n                                                    style={{ maxWidth: cell.column.getSize() }}\r\n                                                >\r\n                                                    {flexRender(cell.column.columnDef.cell, cell.getContext())}\r\n                                                </td>\r\n                                            );\r\n                                        })}\r\n                                    </tr>\r\n                                )\r\n                            })}\r\n                            {paddingBottom > 0 && (\r\n                                <tr>\r\n                                    <td colSpan={columns.length} style={{ height: `${paddingBottom}px` }} />\r\n                                </tr>\r\n                            )}\r\n                        </>\r\n                    )}\r\n                </tbody>\r\n            </table>\r\n        </div>\r\n    )\r\n}\r\n\r\nexport default BomTable\r\n","usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\pages\\BomPage.jsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'bomView' is not defined.","line":126,"column":20,"nodeType":"Identifier","messageId":"undef","endLine":126,"endColumn":27},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has an unnecessary dependency: 'bomView'. Either exclude it or remove the dependency array. Outer scope values like 'bomView' aren't valid dependencies because mutating them doesn't re-render the component.","line":154,"column":8,"nodeType":"ArrayExpression","endLine":154,"endColumn":52,"suggestions":[{"desc":"Update the dependencies array to be: [searchTerm, searchFields, bomMode]","fix":{"range":[5502,5546],"text":"[searchTerm, searchFields, bomMode]"}}]},{"ruleId":"no-undef","severity":2,"message":"'bomView' is not defined.","line":154,"column":9,"nodeType":"Identifier","messageId":"undef","endLine":154,"endColumn":16},{"ruleId":"no-undef","severity":2,"message":"'error' is not defined.","line":441,"column":18,"nodeType":"Identifier","messageId":"undef","endLine":441,"endColumn":23},{"ruleId":"no-undef","severity":2,"message":"'error' is not defined.","line":444,"column":32,"nodeType":"Identifier","messageId":"undef","endLine":444,"endColumn":37},{"ruleId":"no-undef","severity":2,"message":"'isLoading' is not defined.","line":458,"column":40,"nodeType":"Identifier","messageId":"undef","endLine":458,"endColumn":49}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState, useCallback, useMemo, useRef } from 'react'\r\nimport {\r\n    FileSpreadsheet, Upload, Download,\r\n    FolderOpen, ChevronDown, X, RotateCcw, Settings\r\n} from 'lucide-react'\r\nimport useSeriesStore from '../stores/useSeriesStore'\r\nimport useProjectStore from '../stores/useProjectStore'\r\nimport useBomStore from '../stores/useBomStore'\r\nimport useProgressStore from '../stores/useProgressStore'\r\nimport useMatrixStore from '../stores/useMatrixStore'\r\nimport BomTable from '../components/tables/BomTable'\r\nimport BomSidebar from '../components/layout/BomSidebar' // [New]\r\nimport ImportDialog from '../components/dialogs/ImportDialog'\r\nimport ConfirmDialog from '../components/dialogs/ConfirmDialog'\r\nimport MatrixModelDialog from '../components/dialogs/MatrixModelDialog'\r\n\r\n// ========================================\r\n// BOM 檢視頁面\r\n// 提供專案/版本選取、BOM 表格檢視、Excel 匯入匯出功能\r\n// ========================================\r\n\r\nconst DEFAULT_SEARCH_FIELDS = ['hhpn', 'description', 'supplier', 'supplier_pn', 'location']\r\nconst ALL_SEARCH_FIELDS = ['hhpn', 'description', 'supplier', 'supplier_pn', 'location', 'remark']\r\n\r\nconst FIELD_LABELS = {\r\n    hhpn: 'HHPN',\r\n    description: 'Description',\r\n    supplier: 'Supplier',\r\n    supplier_pn: 'Supplier PN',\r\n    location: 'Location',\r\n    remark: 'Remark'\r\n}\r\n\r\n/**\r\n * BOM 檢視頁面元件。\r\n *\r\n * 包含工具列 (專案選擇、版本選擇、匯入/匯出按鈕)\r\n * 及 BOM 聚合表格。使用緊湊佈局以最大化資料展示面積。\r\n *\r\n * @returns {JSX.Element} BOM 檢視頁面\r\n */\r\nfunction BomPage() {\r\n    const { isOpen } = useSeriesStore()\r\n    const { loadProjects } = useProjectStore()\r\n    const {\r\n        selectedRevisionId, selectedRevisionIds, selectedRevision,\r\n        deleteBom, importExcel, exportExcel,\r\n        clearError, reset,\r\n        currentViewId, selectView, \r\n        bomMode \r\n    } = useBomStore()\r\n\r\n    // Check if any export task is running\r\n    const isExporting = useProgressStore(state => \r\n        Array.from(state.sessions.values()).some(s => s.type === 'EXPORT_BOM' && s.status === 'RUNNING')\r\n    )\r\n\r\n    const { fetchMatrixData } = useMatrixStore()\r\n\r\n    // 匯入對話框\r\n    const [isImportOpen, setIsImportOpen] = useState(false)\r\n    const [importFile, setImportFile] = useState(null)\r\n    // 刪除確認對話框\r\n    const [deleteTarget, setDeleteTarget] = useState(null)\r\n    // Matrix Model 管理對話框\r\n    const [isMatrixModelDialogOpen, setIsMatrixModelDialogOpen] = useState(false)\r\n    // 頁面層級拖曳狀態\r\n    const [isDragOver, setIsDragOver] = useState(false)\r\n\r\n    // 視圖狀態 (Definitions)\r\n    const [views, setViews] = useState({})\r\n    \r\n    // 搜尋狀態\r\n    const [searchTerm, setSearchTerm] = useState('')\r\n    const [isSearchOptionsOpen, setIsSearchOptionsOpen] = useState(false)\r\n    const [searchFields, setSearchFields] = useState(new Set(DEFAULT_SEARCH_FIELDS))\r\n\r\n    // Refs for click outside detection\r\n    const searchOptionsPanelRef = useRef(null)\r\n    const searchToggleRef = useRef(null)\r\n\r\n    // Handle click outside to close search options\r\n    useEffect(() => {\r\n        const handleClickOutside = (event) => {\r\n            if (isSearchOptionsOpen && \r\n                searchOptionsPanelRef.current && \r\n                !searchOptionsPanelRef.current.contains(event.target) &&\r\n                searchToggleRef.current &&\r\n                !searchToggleRef.current.contains(event.target)) {\r\n                setIsSearchOptionsOpen(false)\r\n            }\r\n        }\r\n\r\n        document.addEventListener('mousedown', handleClickOutside)\r\n        return () => {\r\n            document.removeEventListener('mousedown', handleClickOutside)\r\n        }\r\n    }, [isSearchOptionsOpen])\r\n\r\n    // 初始化：載入視圖定義\r\n    useEffect(() => {\r\n        const loadViews = async () => {\r\n            try {\r\n                const result = await window.api.bom.getViews()\r\n                if (result.success) {\r\n                    setViews(result.data)\r\n                }\r\n            } catch (err) {\r\n                console.error('Failed to load BOM views:', err)\r\n            }\r\n        }\r\n        loadViews()\r\n    }, [])\r\n\r\n    // 載入 Matrix 資料\r\n    useEffect(() => {\r\n        // Support multi IDs for Matrix Mode\r\n        if (bomMode === 'MATRIX' && selectedRevisionIds.size > 0) {\r\n            const ids = Array.from(selectedRevisionIds);\r\n            fetchMatrixData(ids);\r\n        }\r\n    }, [selectedRevisionIds, bomMode, fetchMatrixData])\r\n\r\n    // 關鍵字過濾邏輯\r\n    const filteredBom = useMemo(() => {\r\n        let data = bomView\r\n\r\n        // Matrix Mode 僅顯示 CCL=Y\r\n        if (bomMode === 'MATRIX' && Array.isArray(data)) {\r\n            data = data.filter(item => item.ccl === 'Y')\r\n        }\r\n\r\n        if (!Array.isArray(data) || !searchTerm || !searchTerm.trim()) return data || []\r\n\r\n        const term = searchTerm.toLowerCase().trim()\r\n        \r\n        // 檢查單一項目是否符合\r\n        const checkMatch = (item) => {\r\n            return Array.from(searchFields).some(field => {\r\n                // Map 'location' key to 'locations' property in source data\r\n                const value = field === 'location' ? item.locations : item[field]\r\n                return value && String(value).toLowerCase().includes(term)\r\n            })\r\n        }\r\n        \r\n        // ... (filter logic unchanged)\r\n        return data.filter(mainItem => {\r\n            if (checkMatch(mainItem)) return true\r\n            if (mainItem.second_sources && mainItem.second_sources.length > 0) {\r\n                if (mainItem.second_sources.some(ss => checkMatch(ss))) return true\r\n            }\r\n            return false\r\n        })\r\n    }, [bomView, searchTerm, searchFields, bomMode])\r\n\r\n\r\n    // 開啟系列後載入專案列表\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            loadProjects()\r\n        } else {\r\n            reset()\r\n        }\r\n    }, [isOpen, loadProjects, reset])\r\n\r\n    /**\r\n     * 處理刪除 BOM 版本確認\r\n     */\r\n    const handleDeleteConfirm = async () => {\r\n        if (deleteTarget) {\r\n            await deleteBom(deleteTarget)\r\n            setDeleteTarget(null)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 處理匯出 Excel\r\n     */\r\n    const handleExport = () => {\r\n        if (selectedRevisionId) {\r\n            exportExcel(selectedRevisionId) // Async fire-and-forget, handled by progress system\r\n        }\r\n    }\r\n\r\n    // ========================================\r\n    // 頁面層級拖曳匯入\r\n    // ========================================\r\n    const handlePageDragOver = useCallback((e) => {\r\n        e.preventDefault()\r\n        e.stopPropagation()\r\n        // 僅在已選擇專案時允許拖曳 (Wait, sidebar selects BOMs, what about project?)\r\n        // If we have selected IDs, we probably can infer project.\r\n        // Or if we have `selectedProjectId` in store.\r\n        // `useBomStore` keeps `selectedProjectId`.\r\n        // Let's assume user must select a project via sidebar to enable drop?\r\n        // Actually, drop on sidebar project item would be cool, but page drop needs context.\r\n        setIsDragOver(true)\r\n    }, [])\r\n\r\n    const handlePageDragLeave = useCallback((e) => {\r\n        e.preventDefault()\r\n        e.stopPropagation()\r\n        setIsDragOver(false)\r\n    }, [])\r\n\r\n    const handlePageDrop = useCallback((e) => {\r\n        e.preventDefault()\r\n        e.stopPropagation()\r\n        setIsDragOver(false)\r\n\r\n        // Find active project if any\r\n        // We need a target project ID. `selectedProjectId` in BomStore is updated when clicking project in sidebar?\r\n        // Let's assume BomStore tracks last selected project.\r\n        // If no project selected, we can't import easily unless we parse filename or ask user.\r\n        // For now, require selectedProjectId.\r\n\r\n        // Warning: BomSidebar updates `selectedRevisionIds`. Does it update `selectedProjectId`?\r\n        // Yes, `BomSidebar` uses `selectProject` or user might click project.\r\n\r\n        // const files = e.dataTransfer?.files\r\n        // ... (Import logic needs valid projectId)\r\n    }, [])\r\n\r\n    // ========================================\r\n    // 未開啟系列 — 提示畫面\r\n    // ========================================\r\n    if (!isOpen) {\r\n        return (\r\n            <div className=\"flex flex-col items-center justify-center h-full gap-4 text-slate-400 dark:text-slate-500 animate-fade-in\">\r\n                <FolderOpen size={48} className=\"text-slate-300 dark:text-slate-600\" />\r\n                <h2 className=\"text-xl font-semibold\">尚未開啟系列</h2>\r\n                <p className=\"text-sm\">請先從首頁建立或開啟系列資料庫，再檢視 BOM。</p>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    // 計算目前選取的版本顯示名稱 (Multi-select handling?)\r\n    const selectionCount = selectedRevisionIds.size;\r\n    const headerTitle = selectionCount === 0\r\n        ? '未選擇 BOM'\r\n        : selectionCount === 1\r\n            ? `${selectedRevision?.phase_name}-${selectedRevision?.version}${selectedRevision?.suffix ? `-${selectedRevision.suffix}` : ''}`\r\n            : `${selectionCount} 個 BOM 已選取`\r\n\r\n    // ========================================\r\n    // 頁面主體\r\n    // ========================================\r\n    return (\r\n        <div className=\"flex h-full animate-fade-in\">\r\n            {/* 側邊欄 */}\r\n            <BomSidebar />\r\n\r\n            {/* 主要內容區 */}\r\n            <div\r\n                className=\"flex-1 flex flex-col min-w-0 p-3 gap-2\"\r\n                onDragOver={handlePageDragOver}\r\n                onDragLeave={handlePageDragLeave}\r\n                onDrop={handlePageDrop}\r\n            >\r\n                {/* 工具列 */}\r\n                <div className=\"flex items-center gap-2 flex-wrap bg-white dark:bg-surface-900 p-2 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800\">\r\n\r\n                    {/* 標題/狀態 */}\r\n                    <div className=\"flex items-center gap-2 px-2 mr-2 border-r border-slate-200 dark:border-slate-700\">\r\n                        <span className=\"font-semibold text-slate-700 dark:text-slate-200\">\r\n                            {headerTitle}\r\n                        </span>\r\n                    </div>\r\n\r\n                    {/* 視圖切換 (View Switcher) - 僅在非 Matrix 模式或 Matrix 模式也需要過濾時顯示 */}\r\n                    {selectionCount > 0 && (\r\n                        <div className=\"flex items-center bg-slate-100 dark:bg-surface-700 rounded-lg p-1\">\r\n                            {['ALL', 'SMD', 'PTH', 'BOTTOM'].map(key => {\r\n                                const view = views[key]\r\n                                if (!view) return null\r\n                                const isActive = currentViewId === view.id\r\n                                return (\r\n                                    <button\r\n                                        key={key}\r\n                                        onClick={() => selectView(view.id)}\r\n                                        className={`px-3 py-1 text-xs font-medium rounded-md transition-all\r\n                                            ${isActive\r\n                                                ? 'bg-white dark:bg-surface-600 text-primary-600 dark:text-primary-400 shadow-sm'\r\n                                                : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'\r\n                                            }`}\r\n                                    >\r\n                                        {key}\r\n                                    </button>\r\n                                )\r\n                            })}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Matrix 設定按鈕 (Only in Matrix Mode) */}\r\n                    {selectionCount > 0 && bomMode === 'MATRIX' && (\r\n                        <button\r\n                            onClick={() => setIsMatrixModelDialogOpen(true)}\r\n                            className=\"p-1.5 ml-2 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-lg transition-colors\"\r\n                            title=\"管理 Matrix Models\"\r\n                        >\r\n                            <Settings size={16} />\r\n                        </button>\r\n                    )}\r\n\r\n                    {/* 搜尋框 (Search) */}\r\n                    {selectionCount > 0 && (\r\n                        <div className=\"relative ml-auto flex flex-col\">\r\n                            <div className=\"relative\">\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={searchTerm}\r\n                                    onChange={(e) => setSearchTerm(e.target.value)}\r\n                                    onDoubleClick={() => setIsSearchOptionsOpen(prev => !prev)}\r\n                                    onFocus={() => setIsSearchOptionsOpen(false)} // Auto-collapse on focus\r\n                                    onKeyDown={(e) => {\r\n                                        if (e.key === 'Escape') {\r\n                                            setSearchTerm('')\r\n                                            setIsSearchOptionsOpen(false)\r\n                                        }\r\n                                    }}\r\n                                    placeholder=\"Search...\"\r\n                                    className={`pl-3 pr-14 py-1.5 text-sm w-40 transition-all\r\n                                        bg-white dark:bg-surface-800\r\n                                        border rounded-lg text-slate-800 dark:text-slate-200\r\n                                        placeholder:text-slate-400\r\n                                        focus:outline-none focus:ring-2 focus:ring-primary-500\r\n                                        ${searchFields.size !== DEFAULT_SEARCH_FIELDS.length ? 'border-amber-400 dark:border-amber-600' : 'border-slate-200 dark:border-slate-700'}\r\n                                        ${isSearchOptionsOpen ? 'w-80' : 'focus:w-60'}`}\r\n                                />\r\n\r\n                                <div className=\"absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1\">\r\n                                    {/* Clear Button */}\r\n                                    {searchTerm && (\r\n                                        <button\r\n                                            onClick={() => setSearchTerm('')}\r\n                                            className=\"text-slate-400 hover:text-slate-600 dark:hover:text-slate-300\"\r\n                                            title=\"Clear search\"\r\n                                        >\r\n                                            <X size={14} />\r\n                                        </button>\r\n                                    )}\r\n\r\n                                    {/* Reset Filter Button (Only show if changed) */}\r\n                                    {searchFields.size !== DEFAULT_SEARCH_FIELDS.length && (\r\n                                        <button\r\n                                            onClick={() => setSearchFields(new Set(DEFAULT_SEARCH_FIELDS))}\r\n                                            className=\"text-amber-500 hover:text-amber-600 transition-colors\"\r\n                                            title=\"Reset search fields\"\r\n                                        >\r\n                                            <RotateCcw size={13} />\r\n                                        </button>\r\n                                    )}\r\n\r\n                                    {/* Toggle Options Button */}\r\n                                    <button\r\n                                        ref={searchToggleRef}\r\n                                        onClick={() => setIsSearchOptionsOpen(prev => !prev)}\r\n                                        className={`text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-transform ${isSearchOptionsOpen ? 'rotate-180' : ''}`}\r\n                                        title=\"Toggle search options\"\r\n                                    >\r\n                                        <ChevronDown size={14} />\r\n                                    </button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Search Options Panel */}\r\n                            {isSearchOptionsOpen && (\r\n                                <div\r\n                                    ref={searchOptionsPanelRef}\r\n                                    className=\"absolute top-full right-0 mt-1 w-80 p-2\r\n                                        bg-white dark:bg-surface-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700\r\n                                        z-50 flex flex-wrap gap-1.5 animate-in fade-in slide-in-from-top-1\"\r\n                                >\r\n                                    {ALL_SEARCH_FIELDS.map(field => {\r\n                                        const isSelected = searchFields.has(field)\r\n                                        return (\r\n                                            <button\r\n                                                key={field}\r\n                                                onClick={() => {\r\n                                                    setSearchFields(prev => {\r\n                                                        const next = new Set(prev)\r\n                                                        if (next.has(field)) next.delete(field)\r\n                                                        else next.add(field)\r\n                                                        if (next.size === 0) return prev\r\n                                                        return next\r\n                                                    })\r\n                                                }}\r\n                                                onDoubleClick={(e) => {\r\n                                                    e.stopPropagation()\r\n                                                    setSearchFields(new Set([field]))\r\n                                                }}\r\n                                                className={`px-2 py-0.5 text-[11px] rounded border transition-colors select-none\r\n                                                    ${isSelected\r\n                                                        ? 'bg-primary-50 text-primary-700 border-primary-200 dark:bg-primary-900/30 dark:text-primary-300 dark:border-primary-700/50 font-medium'\r\n                                                        : 'bg-slate-50 text-slate-500 border-slate-200 dark:bg-surface-700 dark:text-slate-400 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-surface-600'\r\n                                                    }`}\r\n                                                title=\"Click to toggle, Double-click to select only this\"\r\n                                            >\r\n                                                {FIELD_LABELS[field]}\r\n                                            </button>\r\n                                        )\r\n                                    })}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* 分隔線 */}\r\n                    <div className=\"h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1\" />\r\n\r\n                    {/* 匯入按鈕 */}\r\n                    <button\r\n                        onClick={() => setIsImportOpen(true)}\r\n                        // disabled={!selectedProjectId} // Need project context\r\n                        className=\"flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium\r\n                            bg-primary-600 hover:bg-primary-700 text-white\r\n                            rounded-lg shadow-sm transition-colors\r\n                            disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                        title=\"匯入 Excel BOM\"\r\n                    >\r\n                        <Upload size={14} />\r\n                        匯入\r\n                    </button>\r\n\r\n                    {/* 匯出按鈕 */}\r\n                    <button\r\n                        onClick={handleExport}\r\n                        disabled={selectionCount === 0 || isExporting}\r\n                        className=\"flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium\r\n                            bg-primary-600 hover:bg-primary-700 text-white\r\n                            rounded-lg shadow-sm transition-colors\r\n                            disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                        title={isExporting ? \"匯出中...\" : \"匯出 Excel BOM\"}\r\n                    >\r\n                        <Download size={14} className={isExporting ? \"animate-bounce\" : \"\"} />\r\n                        {isExporting ? \"匯出中...\" : \"匯出\"}\r\n                    </button>\r\n                </div>\r\n\r\n                {/* 錯誤提示 */}\r\n                {error && (\r\n                    <div className=\"flex items-center gap-2 px-3 py-1.5 bg-red-50 dark:bg-red-900/20\r\n                        border border-red-200 dark:border-red-800 rounded-lg text-xs text-red-600 dark:text-red-400\">\r\n                        <span>{error}</span>\r\n                        <button onClick={clearError} className=\"ml-auto hover:text-red-800\">\r\n                            <X size={12} />\r\n                        </button>\r\n                    </div>\r\n                )}\r\n\r\n                {/* ========================================\r\n                    BOM 表格 — 主要內容區\r\n                 ======================================== */}\r\n                <div className=\"flex-1 min-h-0 overflow-hidden\">\r\n                    {selectionCount > 0 ? (\r\n                        <BomTable\r\n                            data={filteredBom}\r\n                            isLoading={isLoading}\r\n                            searchTerm={searchTerm}\r\n                            searchFields={searchFields}\r\n                            mode={bomMode}\r\n                            viewContextIds={Array.from(selectedRevisionIds)}\r\n                        />\r\n                    ) : (\r\n                        <div className=\"flex flex-col items-center justify-center h-full gap-3 text-slate-400 dark:text-slate-500\">\r\n                            <FileSpreadsheet size={40} className=\"text-slate-300 dark:text-slate-600\" />\r\n                            <p className=\"text-sm\">\r\n                                請從左側選擇 BOM 版本。\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* 拖曳覆蓋層 */}\r\n            {isDragOver && (\r\n                <div className=\"fixed inset-0 z-50 flex items-center justify-center\r\n                    bg-primary-500/10 dark:bg-primary-400/10\r\n                    border-4 border-dashed border-primary-400 dark:border-primary-500\r\n                    pointer-events-none\">\r\n                    <div className=\"bg-white dark:bg-surface-800 rounded-xl shadow-lg px-8 py-6 text-center\">\r\n                        <Upload size={32} className=\"mx-auto mb-2 text-primary-500\" />\r\n                        <p className=\"text-lg font-semibold text-slate-700 dark:text-white\">放開以匯入 Excel</p>\r\n                        <p className=\"text-sm text-slate-400 mt-1\">支援 .xls / .xlsx 格式</p>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* 匯入對話框 */}\r\n            <ImportDialog\r\n                isOpen={isImportOpen}\r\n                onClose={() => {\r\n                    setIsImportOpen(false)\r\n                    setImportFile(null)\r\n                }}\r\n                projectId={null} // Let dialog handle project selection? Or Sidebar needs to track active project.\r\n                onImport={importExcel}\r\n                initialFile={importFile}\r\n            />\r\n\r\n            {/* Matrix Model 管理對話框 */}\r\n            {/* Use first selected ID for model management? Or disable for multi-select? */}\r\n            {/* User requirement: \"MATRIX 模式支援一到多個BOM... UI 根據 Matrix_Models 的數量動態增加 DataGrid 的橫向欄位\" */}\r\n            {/* But management usually is per BOM. Multi-BOM model management is complex. */}\r\n            {/* Let's disable for multi-select or use the first one. */}\r\n            {selectedRevisionId && (\r\n                <MatrixModelDialog\r\n                    isOpen={isMatrixModelDialogOpen}\r\n                    onClose={() => setIsMatrixModelDialogOpen(false)}\r\n                    bomRevisionId={selectedRevisionId}\r\n                />\r\n            )}\r\n\r\n            {/* 刪除確認對話框 */}\r\n            <ConfirmDialog\r\n                isOpen={!!deleteTarget}\r\n                onClose={() => setDeleteTarget(null)}\r\n                onConfirm={handleDeleteConfirm}\r\n                title=\"刪除 BOM 版本\"\r\n                message={`確定要刪除 BOM 版本？此操作將一併刪除所有零件資料，且無法復原。`}\r\n                confirmText=\"刪除\"\r\n                danger\r\n            />\r\n        </div>\r\n    )\r\n}\r\n\r\nexport default BomPage\r\n","usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\pages\\ComparePage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\pages\\Dashboard.jsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n  76 |         } else {\n  77 |             resetProjects()\n> 78 |             setProjectBoms({})  // 系列關閉時一次性清除本地 BOM 快取\n     |             ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  79 |             setExpandedProjects({})  // 同步清除幕開狀態\n  80 |         }\n  81 |     }, [isOpen, loadProjects, resetProjects])","line":78,"column":13,"nodeType":null,"endLine":78,"endColumn":27}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react'\r\nimport {\r\n    FolderPlus, FolderOpen, Clock, X, Database, ChevronRight,\r\n    Pencil, FileText, Trash2, FileDown \r\n} from 'lucide-react'\r\nimport useSeriesStore from '../stores/useSeriesStore'\r\nimport useProjectStore from '../stores/useProjectStore'\r\nimport useBomStore from '../stores/useBomStore'\r\nimport Dialog from '../components/dialogs/Dialog'\r\nimport ProjectDialog from '../components/dialogs/ProjectDialog' // Assuming this exists or I'll need to check location\r\n\r\nimport BomMetaDialog from '../components/dialogs/BomMetaDialog'\r\nimport ImportDialog from '../components/dialogs/ImportDialog'\r\nimport ConfirmDialog from '../components/dialogs/ConfirmDialog'\r\n\r\n// ========================================\r\n// 儀表板 (Dashboard)\r\n// 整合系列管理與專案/BOM 樹狀檢視\r\n// ========================================\r\n\r\nfunction Dashboard({ onNavigate }) {\r\n    // --- Stores ---\r\n    const {\r\n        isOpen, currentSeries, currentPath, recentFiles, isLoading: isSeriesLoading, error: seriesError,\r\n        initRecentFiles, createSeries, openSeries, closeSeries,\r\n        updateDescription, renameSeries, removeFromRecentFiles, clearError: clearSeriesError,\r\n    } = useSeriesStore()\r\n\r\n    const { \r\n        projects, loadProjects, createProject, updateProject, deleteProject, \r\n        reset: resetProjects \r\n    } = useProjectStore()\r\n\r\n    const { \r\n        selectProject, toggleRevisionSelection, updateRevision, deleteBom\r\n    } = useBomStore()\r\n\r\n    // --- Local State ---\r\n    // Series Description Edit\r\n    const [isEditingDesc, setIsEditingDesc] = useState(false)\r\n    const [editDesc, setEditDesc] = useState('')\r\n\r\n    // Series Rename\r\n    const [isRenameOpen, setIsRenameOpen] = useState(false)\r\n    const [renameValue, setRenameValue] = useState('')\r\n    const [renameError, setRenameError] = useState('')\r\n\r\n    // Project Dialog (Create/Edit)\r\n    const [projectDialog, setProjectDialog] = useState({ isOpen: false, mode: 'create', data: null })\r\n\r\n    // BOM Meta Dialog (Edit)\r\n    const [bomDialog, setBomDialog] = useState({ isOpen: false, data: null })\r\n\r\n    // Import Dialog\r\n    const [importDialog, setImportDialog] = useState({ isOpen: false, projectId: null, projectCode: '' })\r\n\r\n    // Delete Confirm\r\n    const [deleteConfirm, setDeleteConfirm] = useState({ isOpen: false, type: '', data: null })\r\n\r\n    // Tree Data: BOMs per Project { [projectId]: [revisions] }\r\n    const [projectBoms, setProjectBoms] = useState({})\r\n    // Expanded Projects { [projectId]: boolean }\r\n    const [expandedProjects, setExpandedProjects] = useState({})\r\n\r\n    // --- Effects ---\r\n\r\n    // Init Recent Files\r\n    useEffect(() => {\r\n        initRecentFiles()\r\n    }, [initRecentFiles])\r\n\r\n    // 系列開啟時載入專案，關閉時重置\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            loadProjects()\r\n        } else {\r\n            resetProjects()\r\n            setProjectBoms({})  // 系列關閉時一次性清除本地 BOM 快取\r\n            setExpandedProjects({})  // 同步清除幕開狀態\r\n        }\r\n    }, [isOpen, loadProjects, resetProjects])\r\n\r\n    // 載入所有專案的 BOM 資料並建立樹狀結構\r\n    useEffect(() => {\r\n        if (isOpen && projects.length > 0) {\r\n            projects.forEach(p => {\r\n                window.api.bom.getRevisions(p.id).then(async (res) => {\r\n                    if (res.success) {\r\n                        const boms = res.data;\r\n                        // 取得每個 BOM 的 Matrix 要約\r\n                        const bomsWithMatrix = await Promise.all(boms.map(async (bom) => {\r\n                             try {\r\n                                 const summaryRes = await window.api.matrix.getSummary(bom.id);\r\n                                 return {\r\n                                     ...bom,\r\n                                     matrixSummary: summaryRes.success ? summaryRes.data : null\r\n                                 };\r\n                             } catch (_e) {\r\n                                 return bom;\r\n                             }\r\n                        }));\r\n                        setProjectBoms(prev => ({ ...prev, [p.id]: bomsWithMatrix }))\r\n                    }\r\n                })\r\n            })\r\n            // 預設展開所有專案：在待機任務中執行，避免在 Effect 同步路徑中 setState\r\n            Promise.resolve().then(() => {\r\n                const initialExpanded = {}\r\n                projects.forEach(p => initialExpanded[p.id] = true)\r\n                setExpandedProjects(prev => ({ ...initialExpanded, ...prev }))\r\n            })\r\n        }\r\n    }, [isOpen, projects])\r\n\r\n    // --- Handlers: Series ---\r\n\r\n    const handleSeriesCreate = async () => createSeries()\r\n    const handleSeriesOpen = async (filePath) => openSeries(filePath)\r\n    const handleSeriesClose = () => closeSeries()\r\n\r\n    const handleStartEditDesc = () => {\r\n        setEditDesc(currentSeries?.description || '')\r\n        setIsEditingDesc(true)\r\n    }\r\n\r\n    const handleSaveDesc = async () => {\r\n        await updateDescription(editDesc)\r\n        setIsEditingDesc(false)\r\n    }\r\n\r\n    const handleOpenRename = () => {\r\n        const name = currentPath?.split(/[\\\\/]/).pop().replace('.bomix', '') || ''\r\n        setRenameValue(name)\r\n        setRenameError('')\r\n        setIsRenameOpen(true)\r\n    }\r\n\r\n    const handleRenameSubmit = async () => {\r\n        if (!renameValue.trim()) return\r\n        const result = await renameSeries(renameValue.trim())\r\n        if (result.success) setIsRenameOpen(false)\r\n        else setRenameError(result.error)\r\n    }\r\n\r\n    // --- Handlers: Project ---\r\n\r\n    const handleCreateProject = () => {\r\n        setProjectDialog({ isOpen: true, mode: 'create', data: null })\r\n    }\r\n\r\n    const handleEditProject = (project) => {\r\n        setProjectDialog({ isOpen: true, mode: 'edit', data: project })\r\n    }\r\n\r\n    const handleProjectSave = async (code, desc) => {\r\n        if (projectDialog.mode === 'create') {\r\n            await createProject(code, desc)\r\n        } else {\r\n            // Check project.service.js updateProject(id, data)\r\n            // It expects { project_code, description }\r\n            // If code is not changed, maybe don't send it? Or service handles unique check.\r\n            // Since we upgraded service to support project_code update.\r\n            await updateProject(projectDialog.data.id, { project_code: code, description: desc })\r\n        }\r\n        setProjectDialog({ ...projectDialog, isOpen: false })\r\n    }\r\n\r\n    const handleDeleteProject = (project) => {\r\n        setDeleteConfirm({ \r\n            isOpen: true, \r\n            type: 'project', \r\n            data: project,\r\n            title: '刪除專案',\r\n            message: `確定要刪除專案「${project.project_code}」？此操作將刪除該專案下所有 BOM 資料且無法復原。`,\r\n            danger: true,\r\n            confirmText: \"刪除\"\r\n        })\r\n    }\r\n\r\n    const toggleProjectExpand = (projectId) => {\r\n        setExpandedProjects(prev => ({ ...prev, [projectId]: !prev[projectId] }))\r\n    }\r\n\r\n    // --- Handlers: BOM ---\r\n\r\n    const handleEditBom = (bom, projectCode) => {\r\n        setBomDialog({ isOpen: true, data: bom, projectCode })\r\n    }\r\n\r\n    const handleBomSave = async (id, updates) => {\r\n        const result = await updateRevision(id, updates)\r\n        if (result.success) {\r\n            // Refresh local BOM list for this project\r\n            // We need to know which project this BOM belongs to.\r\n            // Updates return the updated object.\r\n            // Or we just re-fetch revisions for that project.\r\n            // Manual update:\r\n            // updateRevision returns { success: true } in store, BUT I should have it return data.\r\n            // In Store:\r\n            /*\r\n            if (result.success) {\r\n                // ...\r\n                return { success: true } // It doesn't return data in my modification!\r\n            }\r\n            */\r\n            // I should re-fetch revisions for the project.\r\n            // I'll re-fetch all for simplicity or find projectId from bom.\r\n            const projectId = bomDialog.data.project_id\r\n            const res = await window.api.bom.getRevisions(projectId)\r\n            if (res.success) {\r\n                setProjectBoms(prev => ({ ...prev, [projectId]: res.data }))\r\n            }\r\n        }\r\n        setBomDialog({ ...bomDialog, isOpen: false })\r\n    }\r\n\r\n    const handleBomClick = async (bom) => {\r\n        await selectProject(bom.project_id)\r\n        await toggleRevisionSelection(bom.id, false) // false for single select\r\n        onNavigate('bom')\r\n    }\r\n\r\n    const handleDeleteBom = (bom) => {\r\n        setDeleteConfirm({ \r\n            isOpen: true, \r\n            type: 'bom', \r\n            data: bom,\r\n            title: '刪除 BOM 版本',\r\n            message: `確定要刪除 BOM 版本「${bom.phase_name} ${bom.version}」？`,\r\n            danger: true,\r\n            confirmText: \"刪除\"\r\n        })\r\n    }\r\n\r\n    // --- Handlers: Import ---\r\n\r\n    const handleImportOpen = (project) => {\r\n        setImportDialog({ isOpen: true, projectId: project.id, projectCode: project.project_code })\r\n    }\r\n\r\n    const handleImportSubmit = async (filePath, projectId, phaseName, version) => {\r\n        // Step 1: Attempt Import\r\n        const ipcResult = await window.api.excel.import(filePath, projectId, phaseName, version)\r\n        \r\n        if (!ipcResult.success) {\r\n            return { success: false, error: ipcResult.error }\r\n        }\r\n\r\n        const result = ipcResult.data;\r\n\r\n        if (result.success) {\r\n            // Success\r\n            // Refresh BOM list\r\n            const res = await window.api.bom.getRevisions(projectId)\r\n            if (res.success) {\r\n                setProjectBoms(prev => ({ ...prev, [projectId]: res.data }))\r\n                // Expand project if not expanded\r\n                setExpandedProjects(prev => ({ ...prev, [projectId]: true }))\r\n            }\r\n            return { success: true }\r\n        } else if (result.error === 'PROJECT_CODE_MISMATCH') {\r\n            // Step 2: Mismatch Warning\r\n            setImportDialog(prev => ({ ...prev, isOpen: false }))\r\n            \r\n            // Check if project already exists\r\n            const parsedCode = result.parsedProjectCode\r\n            const existingProject = projects.find(p => p.project_code.toLowerCase() === parsedCode.toLowerCase())\r\n\r\n            if (existingProject) {\r\n                 // Case A: Project Exists -> Suggest Import to Existing\r\n                 setDeleteConfirm({\r\n                    isOpen: true,\r\n                    type: 'import_mismatch_existing',\r\n                    data: { filePath, phaseName, version, targetProjectId: existingProject.id, targetProjectCode: existingProject.project_code },\r\n                    title: '專案代碼不符（專案已存在）',\r\n                    message: `BOM 表頭專案代碼「${parsedCode}」與目前專案「${importDialog.projectCode}」不符。\\n\\n系統偵測到專案「${existingProject.project_code}」已經存在。\\n是否將 BOM 直接匯入至「${existingProject.project_code}」？`,\r\n                    confirmText: `匯入至 ${existingProject.project_code}`,\r\n                    variant: 'info'\r\n                })\r\n            } else {\r\n                // Case B: Project New -> Suggest Create New\r\n                setDeleteConfirm({\r\n                    isOpen: true,\r\n                    type: 'import_mismatch',\r\n                    data: { filePath, phaseName, version, parsedCode },\r\n                    title: '專案代碼不符',\r\n                    message: `BOM 表頭專案代碼「${parsedCode}」與目前專案「${importDialog.projectCode}」不符。\\n是否依據 BOM 建立「${parsedCode}」專案，並將 BOM 匯入到新專案？`,\r\n                    confirmText: '創建並匯入',\r\n                    variant: 'success'\r\n                })\r\n            }\r\n            return { success: false, error: '專案代碼不符，請確認' } \r\n        } else {\r\n            // Other errors\r\n            return { success: false, error: result.error }\r\n        }\r\n    }\r\n    \r\n    // Handle Mismatch Confirm (Create New Project)\r\n    // We need to modify handleConfirmDelete/Confirm logic to handle this new type.\r\n    const handleConfirmAction = async () => {\r\n        const { type, data } = deleteConfirm\r\n        \r\n        if (type === 'import_mismatch_existing') {\r\n            try {\r\n                 // Direct Import to Existing Project\r\n                 const importIpcRes = await window.api.excel.import(data.filePath, data.targetProjectId, data.phaseName, data.version)\r\n                 \r\n                 if (importIpcRes.success && importIpcRes.data.success) {\r\n                     // Refresh BOMs for target project\r\n                     const res = await window.api.bom.getRevisions(data.targetProjectId)\r\n                     if (res.success) {\r\n                         setProjectBoms(prev => ({ ...prev, [data.targetProjectId]: res.data }))\r\n                         setExpandedProjects(prev => ({ ...prev, [data.targetProjectId]: true }))\r\n                     }\r\n                 } else {\r\n                     const errMsg = importIpcRes.success ? importIpcRes.data.error : importIpcRes.error;\r\n                     alert(`匯入至現有專案失敗: ${errMsg}`)\r\n                 }\r\n            } catch (e) {\r\n                console.error(e)\r\n                alert(`匯入發生錯誤: ${e.message}`)\r\n            }\r\n            setDeleteConfirm({ ...deleteConfirm, isOpen: false })\r\n            return\r\n        }\r\n\r\n        if (type === 'import_mismatch') {\r\n            // Create New Project with parsedCode\r\n            // Check if exists first? createProject handles unique constraint error?\r\n            try {\r\n                // Determine description? Use parsedCode or empty.\r\n                const projectRes = await createProject(data.parsedCode, `Imported from ${data.parsedCode}`)\r\n                \r\n                if (projectRes.success && projectRes.data) {\r\n                     const newProjectId = projectRes.data.id\r\n                     // loadProjects is called inside createProject\r\n                     \r\n                     // Retry Import\r\n                     const importIpcRes = await window.api.excel.import(data.filePath, newProjectId, data.phaseName, data.version)\r\n                     \r\n                     if (importIpcRes.success && importIpcRes.data.success) {\r\n                         // Refresh BOMs for new project\r\n                         // We still need to help UI expand/update.\r\n                         // createProject calls loadProjects, so projects list is updated.\r\n                         // But we need to update projectBoms for the new project.\r\n                         const res = await window.api.bom.getRevisions(newProjectId)\r\n                         if (res.success) {\r\n                             setProjectBoms(prev => ({ ...prev, [newProjectId]: res.data }))\r\n                             setExpandedProjects(prev => ({ ...prev, [newProjectId]: true }))\r\n                         }\r\n                     } else {\r\n                         // Import failed after create\r\n                         const errMsg = importIpcRes.success ? importIpcRes.data.error : importIpcRes.error;\r\n                         alert(`新專案建立成功，但匯入失敗: ${errMsg}`)\r\n                     }\r\n                } else {\r\n                     alert(`建立新專案失敗: ${projectRes.error}`)\r\n                }\r\n            } catch (e) {\r\n                console.error(e)\r\n            }\r\n            setDeleteConfirm({ ...deleteConfirm, isOpen: false })\r\n            return\r\n        }\r\n\r\n        // Original Delete Logic\r\n        if (type === 'project') {\r\n             // ...\r\n             await deleteProject(data.id)\r\n        } else if (type === 'bom') {\r\n             await deleteBom(data.id)\r\n             // Refresh BOM list\r\n             const res = await window.api.bom.getRevisions(data.project_id)\r\n             if (res.success) {\r\n                 setProjectBoms(prev => ({ ...prev, [data.project_id]: res.data }))\r\n             }\r\n        }\r\n        setDeleteConfirm({ ...deleteConfirm, isOpen: false })\r\n    }\r\n\r\n\r\n    // ========================================\r\n    // A. 歡迎畫面 (未開啟系列)\r\n    // ========================================\r\n    if (!isOpen) {\r\n        return (\r\n            <div className=\"flex flex-col items-center justify-center h-full gap-8 p-6 overflow-auto animate-fade-in relative\">\r\n                 {/* 錯誤提示 */}\r\n                 {seriesError && (\r\n                    <div className=\"absolute top-4 left-1/2 -translate-x-1/2 flex items-center gap-2 px-4 py-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-sm text-red-600 dark:text-red-400 shadow-md\">\r\n                        <span>{seriesError}</span>\r\n                        <button onClick={clearSeriesError} className=\"ml-2 hover:text-red-800\">\r\n                            <X size={14} />\r\n                        </button>\r\n                    </div>\r\n                )}\r\n            \r\n                <div className=\"text-center\">\r\n                    <h1 className=\"text-4xl font-bold text-primary-600 dark:text-primary-400 mb-2\">BOMIX</h1>\r\n                    <p className=\"text-lg text-slate-500 dark:text-slate-400\">BOM 變化管理與追蹤工具</p>\r\n                </div>\r\n\r\n                <div className=\"flex gap-4\">\r\n                    <button onClick={handleSeriesCreate} disabled={isSeriesLoading}\r\n                        className=\"flex flex-col items-center gap-2 px-8 py-6 bg-white dark:bg-surface-800 rounded-xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-700 hover:border-primary-300 dark:hover:border-primary-600 transition-all duration-200 cursor-pointer group disabled:opacity-50\">\r\n                        <span className=\"text-primary-500 group-hover:scale-110 transition-transform\"><FolderPlus size={32} /></span>\r\n                        <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">建立新系列</span>\r\n                    </button>\r\n                    <button onClick={() => handleSeriesOpen()} disabled={isSeriesLoading}\r\n                        className=\"flex flex-col items-center gap-2 px-8 py-6 bg-white dark:bg-surface-800 rounded-xl shadow-sm hover:shadow-md border border-slate-200 dark:border-slate-700 hover:border-primary-300 dark:hover:border-primary-600 transition-all duration-200 cursor-pointer group disabled:opacity-50\">\r\n                        <span className=\"text-primary-500 group-hover:scale-110 transition-transform\"><FolderOpen size={32} /></span>\r\n                        <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">開啟系列</span>\r\n                    </button>\r\n                </div>\r\n\r\n                <div className=\"w-full max-w-md\">\r\n                    <h2 className=\"text-sm font-semibold text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2\">\r\n                        <Clock size={14} /> 最近開啟\r\n                    </h2>\r\n                    {recentFiles.length > 0 ? (\r\n                        <div className=\"bg-white dark:bg-surface-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden divide-y divide-slate-100 dark:divide-slate-700\">\r\n                            {recentFiles.map((filePath) => {\r\n                                const name = filePath.split(/[\\\\/]/).pop()?.replace('.bomix', '') || filePath\r\n                                return (\r\n                                    <div key={filePath} className=\"flex items-center justify-between p-3 hover:bg-slate-50 dark:hover:bg-surface-700/50 transition-colors group\">\r\n                                        <button onClick={() => handleSeriesOpen(filePath)} className=\"flex-1 flex items-center gap-3 text-left min-w-0\">\r\n                                            <Database size={16} className=\"shrink-0 text-primary-500\" />\r\n                                            <div className=\"min-w-0\">\r\n                                                <p className=\"text-sm font-medium text-slate-700 dark:text-slate-200 truncate\">{name}</p>\r\n                                                <p className=\"text-xs text-slate-400 truncate font-mono\">{filePath}</p>\r\n                                            </div>\r\n                                            <ChevronRight size={14} className=\"shrink-0 text-slate-300 group-hover:text-primary-500 transition-colors\" />\r\n                                        </button>\r\n                                        <button onClick={() => removeFromRecentFiles(filePath)} className=\"shrink-0 ml-2 p-1 rounded hover:bg-slate-200 dark:hover:bg-surface-600 text-slate-300 hover:text-slate-500 opacity-0 group-hover:opacity-100 transition-all\">\r\n                                            <X size={14} />\r\n                                        </button>\r\n                                    </div>\r\n                                )\r\n                            })}\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"p-4 text-center text-sm text-slate-400 border border-slate-200 dark:border-slate-700 rounded-xl\">尚無開啟記錄</div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    // ========================================\r\n    // B. Dashboard (已開啟系列)\r\n    // ========================================\r\n    const displayName = currentPath?.split(/[\\\\/]/).pop().replace('.bomix', '') || '未命名系列'\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full animate-fade-in bg-slate-50 dark:bg-surface-950\">\r\n            {/* 1. Header Area: Series Info */}\r\n            <div className=\"bg-white dark:bg-surface-900 border-b border-slate-200 dark:border-slate-800 px-6 py-4 flex items-center justify-between shrink-0\">\r\n                <div className=\"flex items-center gap-4 min-w-0\">\r\n                    <div className=\"p-3 bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-xl\">\r\n                        <Database size={24} />\r\n                    </div>\r\n                    <div className=\"min-w-0\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <h2 className=\"text-xl font-bold text-slate-800 dark:text-white truncate\">{displayName}</h2>\r\n                            <button onClick={handleOpenRename} className=\"p-1 rounded-md text-slate-400 hover:text-primary-600 hover:bg-slate-100 dark:hover:bg-surface-800 transition-colors\">\r\n                                <Pencil size={14} />\r\n                            </button>\r\n                        </div>\r\n                        {isEditingDesc ? (\r\n                            <div className=\"flex gap-2 mt-1\">\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={editDesc}\r\n                                    onChange={(e) => setEditDesc(e.target.value)}\r\n                                    className=\"px-2 py-0.5 text-sm border rounded bg-white dark:bg-surface-800 dark:border-slate-700 dark:text-slate-200 focus:ring-1 focus:ring-primary-500\"\r\n                                    autoFocus\r\n                                    onKeyDown={(e) => e.key === 'Enter' && handleSaveDesc()}\r\n                                />\r\n                                <button onClick={handleSaveDesc} className=\"px-2 py-0.5 bg-primary-600 text-white rounded text-xs\">儲存</button>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"flex items-center gap-2 group cursor-pointer mt-1\" onClick={handleStartEditDesc}>\r\n                                <p className=\"text-sm text-slate-500 truncate max-w-lg\">{currentSeries.description || '點擊新增描述...'}</p>\r\n                                <Pencil size={12} className=\"opacity-0 group-hover:opacity-100 text-slate-400\" />\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n                <div className=\"flex items-center gap-3\">\r\n                     <button onClick={handleCreateProject} className=\"flex items-center gap-1.5 px-3 py-1.5 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 shadow-sm transition-colors\">\r\n                        <FolderPlus size={16} />\r\n                        新增專案\r\n                    </button>\r\n                    <button onClick={handleSeriesClose} className=\"p-2 text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-800 rounded-lg transition-colors\" title=\"關閉系列\">\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* 2. Content Area: Tree View */}\r\n            <div className=\"flex-1 overflow-auto p-6\">\r\n                <div className=\"max-w-5xl mx-auto\">\r\n                    {projects.length === 0 ? (\r\n                        <div className=\"text-center py-20 text-slate-400\">\r\n                            <FolderOpen size={48} className=\"mx-auto mb-4 opacity-20\" />\r\n                            <p>尚無專案，請點擊右上方「新增專案」</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"space-y-4\">\r\n                            {projects.map(project => (\r\n                                <div key={project.id} className=\"bg-white dark:bg-surface-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden\">\r\n                                    {/* Project Header */}\r\n                                    <div \r\n                                        className=\"flex items-center justify-between p-3 cursor-pointer hover:bg-slate-50 dark:hover:bg-surface-800/50 transition-colors\"\r\n                                        onClick={() => toggleProjectExpand(project.id)}\r\n                                    >\r\n                                        <div className=\"flex items-center gap-3\">\r\n                                            <ChevronRight size={18} className={`text-slate-400 transition-transform ${expandedProjects[project.id] ? 'rotate-90' : ''}`} />\r\n                                            <FolderOpen size={20} className=\"text-sky-500\" />\r\n                                            <div>\r\n                                                <h3 className=\"font-medium text-slate-800 dark:text-slate-200\">{project.project_code}</h3>\r\n                                                {project.description && <p className=\"text-xs text-slate-400\">{project.description}</p>}\r\n                                            </div>\r\n                                        </div>\r\n                                        <div className=\"flex items-center gap-2\" onClick={e => e.stopPropagation()}>\r\n\r\n                                            <button \r\n                                                onClick={() => handleImportOpen(project)}\r\n                                                className=\"p-1.5 text-slate-400 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded transition-colors\"\r\n                                                title=\"匯入 BOM\"\r\n                                            >\r\n                                                <FileDown size={15} />\r\n                                            </button>\r\n                                \r\n                                            <button \r\n                                                onClick={() => handleEditProject(project)}\r\n                                                className=\"p-1.5 text-slate-400 hover:text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded transition-colors\"\r\n                                                title=\"編輯專案\"\r\n                                            >\r\n                                                <Pencil size={15} />\r\n                                            </button>\r\n                                            <div className=\"w-px h-4 bg-slate-200 dark:bg-slate-700 mx-1\"></div>\r\n\r\n                                            <button \r\n                                                onClick={() => handleDeleteProject(project)}\r\n                                                className=\"p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors\"\r\n                                                title=\"刪除專案\"\r\n                                            >\r\n                                                <Trash2 size={15} />\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* BOM List (Children) */}\r\n                                    {expandedProjects[project.id] && (\r\n                                        <div className=\"border-t border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-surface-950/30 px-3 py-2\">\r\n                                            <div className=\"ml-9 space-y-1\">\r\n                                                {projectBoms[project.id]?.length > 0 ? (\r\n                                                    projectBoms[project.id].map(bom => (\r\n                                                        <div \r\n                                                            key={bom.id} \r\n                                                            className=\"flex items-center justify-between p-2 rounded-lg hover:bg-white dark:hover:bg-surface-800 border border-transparent hover:border-slate-200 dark:hover:border-slate-700 transition-all cursor-pointer group\"\r\n                                                            onClick={() => handleBomClick(bom)}\r\n                                                        >\r\n                                                            <div className=\"flex items-center gap-3\">\r\n                                                                <FileText size={16} className=\"text-emerald-500\" />\r\n                                                                <span className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">\r\n                                                                    {bom.phase_name} {bom.version}\r\n                                                                    {bom.suffix && <span className=\"ml-1 text-slate-500\">-{bom.suffix}</span>}\r\n                                                                </span>\r\n                                                                <span className=\"text-xs px-1.5 py-0.5 bg-slate-100 dark:bg-surface-700 text-slate-500 rounded text-[10px]\">\r\n                                                                    {bom.mode || 'NPI'}\r\n                                                                </span>\r\n                                                                {bom.matrixSummary && bom.matrixSummary.hasMatrix && (\r\n                                                                    <div className=\"flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-800\" title={bom.matrixSummary.isSafe ? \"Matrix Complete\" : \"Matrix Incomplete\"}>\r\n                                                                        <span className=\"font-semibold text-slate-500\">M</span>\r\n                                                                        <div className={`w-1.5 h-1.5 rounded-full ${bom.matrixSummary.isSafe ? 'bg-green-500' : 'bg-amber-500'}`} />\r\n                                                                    </div>\r\n                                                                )}\r\n                                                                {bom.bom_date && <span className=\"text-xs text-slate-400\">{bom.bom_date}</span>}\r\n                                                            </div>\r\n                                                            <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\" onClick={e => e.stopPropagation()}>\r\n                                                                <button \r\n                                                                    onClick={() => handleEditBom(bom, project.project_code)}\r\n                                                                    className=\"p-1 text-slate-400 hover:text-primary-600 rounded\"\r\n                                                                    title=\"編輯 BOM 屬性\"\r\n                                                                >\r\n                                                                    <Pencil size={14} />\r\n                                                                </button>\r\n                                                                <button \r\n                                                                    onClick={() => handleDeleteBom(bom)}\r\n                                                                    className=\"p-1 text-slate-400 hover:text-red-600 rounded\"\r\n                                                                    title=\"刪除 BOM\"\r\n                                                                >\r\n                                                                    <Trash2 size={14} />\r\n                                                                </button>\r\n                                                            </div>\r\n                                                        </div>\r\n                                                    ))\r\n                                                ) : (\r\n                                                    <div className=\"text-xs text-slate-400 py-2 pl-2 italic\">尚無 BOM 版本</div>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Dialogs */}\r\n            <Dialog\r\n                isOpen={isRenameOpen}\r\n                onClose={() => setIsRenameOpen(false)}\r\n                title=\"重新命名系列\"\r\n                className=\"max-w-sm\"\r\n            >\r\n                <div className=\"space-y-4\">\r\n                    <input\r\n                        type=\"text\"\r\n                        value={renameValue}\r\n                        onChange={(e) => setRenameValue(e.target.value)}\r\n                        placeholder=\"輸入新的系列名稱\"\r\n                        className=\"w-full px-3 py-2 text-sm border rounded-lg dark:bg-surface-900 dark:border-slate-600\"\r\n                    />\r\n                    {renameError && <p className=\"text-xs text-red-500\">{renameError}</p>}\r\n                    <div className=\"flex justify-end gap-2\">\r\n                        <button onClick={() => setIsRenameOpen(false)} className=\"px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-surface-700 rounded-lg\">取消</button>\r\n                        <button onClick={handleRenameSubmit} className=\"px-4 py-2 text-sm bg-primary-600 text-white rounded-lg\">確定</button>\r\n                    </div>\r\n                </div>\r\n            </Dialog>\r\n\r\n            <ProjectDialog\r\n                isOpen={projectDialog.isOpen}\r\n                onClose={() => setProjectDialog({ ...projectDialog, isOpen: false })}\r\n                mode={projectDialog.mode}\r\n                initialData={projectDialog.data}\r\n                onSave={handleProjectSave}\r\n            />\r\n\r\n            <BomMetaDialog \r\n                isOpen={bomDialog.isOpen}\r\n                onClose={() => setBomDialog({ ...bomDialog, isOpen: false })}\r\n                bom={bomDialog.data}\r\n                projectCode={bomDialog.projectCode}\r\n                onSave={handleBomSave}\r\n            />\r\n\r\n            <ImportDialog\r\n                isOpen={importDialog.isOpen}\r\n                onClose={() => setImportDialog({ ...importDialog, isOpen: false })}\r\n                projectId={importDialog.projectId}\r\n                projectCode={importDialog.projectCode}\r\n                onImport={handleImportSubmit}\r\n            />\r\n\r\n            <ConfirmDialog \r\n                isOpen={deleteConfirm.isOpen}\r\n                onClose={() => setDeleteConfirm({ ...deleteConfirm, isOpen: false })}\r\n                onConfirm={handleConfirmAction}\r\n                title={deleteConfirm.title}\r\n                message={deleteConfirm.message}\r\n                confirmText={deleteConfirm.confirmText || \"確認\"}\r\n                danger={deleteConfirm.danger} // Keeping for backward compatibility if mixed usage\r\n                variant={deleteConfirm.variant || (deleteConfirm.danger ? 'danger' : 'primary')}\r\n            />\r\n        </div>\r\n    )\r\n}\r\n\r\nexport default Dashboard\r\n","usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\pages\\HomePage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\pages\\ProjectPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\pages\\SettingsPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\stores\\useAppStore.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\stores\\useBomStore.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\stores\\useMatrixStore.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\stores\\useProgressStore.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\stores\\useProjectStore.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\stores\\useSeriesStore.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\src\\renderer\\stores\\useSettingsStore.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"Z:\\Programming\\BOMIX\\vitest.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]